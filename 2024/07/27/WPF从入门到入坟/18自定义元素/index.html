<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>WPF从入门到入坟 - 18自定义元素 | 生活中的tree</title><meta name="author" content="大白"><meta name="copyright" content="大白"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="&emsp;&emsp;WPF支持样式、内容控件和模板，因此不再强调自定义控件。这些特性为每位开发人员提供了多种方式来完善和扩展标准的控件，而不用派生新的控件类。下面是几种可能的选择：  样式。可使用样式方便地重用控件属性的组合。甚至可使用触发器应用效果 内容控件。所有继承自ContentControl类的控件都支持嵌套的内容。使用内容控件，可以快速创建聚集其他元素的复合控件 控件模板。所有WPF">
<meta property="og:type" content="article">
<meta property="og:title" content="WPF从入门到入坟 - 18自定义元素">
<meta property="og:url" content="http://bootree.cn/2024/07/27/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/18%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%83%E7%B4%A0/index.html">
<meta property="og:site_name" content="生活中的tree">
<meta property="og:description" content="&emsp;&emsp;WPF支持样式、内容控件和模板，因此不再强调自定义控件。这些特性为每位开发人员提供了多种方式来完善和扩展标准的控件，而不用派生新的控件类。下面是几种可能的选择：  样式。可使用样式方便地重用控件属性的组合。甚至可使用触发器应用效果 内容控件。所有继承自ContentControl类的控件都支持嵌套的内容。使用内容控件，可以快速创建聚集其他元素的复合控件 控件模板。所有WPF">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png">
<meta property="article:published_time" content="2024-07-27T07:38:23.000Z">
<meta property="article:modified_time" content="2024-07-30T14:51:13.810Z">
<meta property="article:author" content="大白">
<meta property="article:tag" content="WPF从入门到入坟">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://bootree.cn/2024/07/27/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/18%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%83%E7%B4%A0/index.html"><link rel="preconnect" href="https://jsd.012700.xyz"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="NdIUXAOVyGnnBhcrip0ksCawbdAzT0hlBZDE9u4jx6k"/><meta name="msvalidate.01" content="567E47D75E8DCF1282B9623AD914701E"/><meta name="baidu-site-verification" content="code-pE5rnuxcfD"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://jsd.012700.xyz/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://jsd.012700.xyz/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: 大白","link":"链接: ","source":"来源: 生活中的tree","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://jsd.012700.xyz/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'WPF从入门到入坟 - 18自定义元素',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-30 22:51:13'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="preconnect" href="https://jsd.012700.xyz"><link href="/self/btf.css" rel="stylesheet"><link rel="alternate" href="/atom.xml" title="生活中的tree" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png')"><nav id="nav"><span id="blog-info"><a href="/" title="生活中的tree"><span class="site-name">生活中的tree</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-compass"></i><span> 目录</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fa fa-heartbeat"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">WPF从入门到入坟 - 18自定义元素<a class="post-edit-link" href="https://github.com/cnlicm/HexoBlog/tree/main/source/_posts/WPF从入门到入坟/18自定义元素.md" rel="external nofollow noreferrer" title="编辑" target="_blank"><i class="fas fa-pencil-alt"></i></a></h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2024-07-27T07:38:23.000Z" title="发表于 2024-07-27 15:38:23">2024-07-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C#</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/WPF/">WPF</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">22.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>84分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="WPF从入门到入坟 - 18自定义元素"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>&emsp;&emsp;WPF支持样式、内容控件和模板，因此不再强调自定义控件。这些特性为每位开发人员提供了多种方式来完善和扩展标准的控件，而不用派生新的控件类。下面是几种可能的选择：</p>
<ul>
<li><strong>样式</strong>。可使用样式方便地重用控件属性的组合。甚至可使用触发器应用效果</li>
<li><strong>内容控件</strong>。所有继承自<code>ContentControl</code>类的控件都支持嵌套的内容。使用内容控件，可以快速创建聚集其他元素的复合控件</li>
<li><strong>控件模板</strong>。所有WPF控件都是无外观的。这意味着它们具有硬编码的功能，但它们的外观是通过控件模板单独定义的。使用其他新的控件模板代替默认模板，可重新构建基本控件</li>
<li><strong>数据模板</strong>。所有派生自<code>ItemsControl</code>的类都支持数据模板，通过数据模板可创建某些数据对象类型的富列表示。通过恰当的数据模板，可使用许多元素的组合显示每个项，这些组合元素可以是文本、图像甚至可以是可编辑控件（都在所需的布局容器中）</li>
</ul>
<div class="note info flat"><p>&emsp;&emsp;如果可能的话，在决定创建自定义控件或其他了；诶新的自定义元素之前，可继续使用这些方法。这是因为这些解决方案更简单，更容易实现，并且通常更容易重用</p>
</div>

<blockquote>
<p>那么，何时应创建自定义元素呢?</p>
</blockquote>
<p>&emsp;&emsp;<strong>当希望微调元素的外观时，自定义元素并非最佳选择，但当希望改变底层的功能时，自定义元素就十分有用了</strong>。例如，WPF为TextBox控件和PasswordBox 控件使用不同的类是有原因的。它们使用不同的方法处理按键，以不同方式在内部保存它们的数据，以不同的方式与其他组件(如剪贴板)进行交互，等等。同样，<strong>如果希望设计一个具有不同属性、方法和事件集合的控件，就需要自己构建该控件。</strong></p>
<h2 id="理解WPF中的自定义元素"><a href="#理解WPF中的自定义元素" class="headerlink" title="理解WPF中的自定义元素"></a>理解WPF中的自定义元素</h2><p>&emsp;&emsp;尽管可在任意WPF项目中编写自定义元素，但通常希望在专门的类库程序集(DLL)中放置自定义元素。这样，可在多个WPF应用程序之间共享自定义元素。</p>
<p>&emsp;&emsp;为确保具有正确的程序集引用和名称空间导入，当在Visual Studio中创建应用程序时，应当选择<code>Custom Control Library(WPF)</code>项目类型。在类库中，可创建任意数量的控件。</p>
<p>&emsp;&emsp;通常自定义控件的第一步是选择争取的基类进行继承，下图列出了创建自定义控件时一些常用的基类：</p>
<center>用于创建自定义元素的基类</center>

<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>FrameworkElement</td>
<td>当创建自定义元素时，这是常用的最低级的基类。通常，只希望重写<code>OnRender()</code>方法并使用<code>System.Windows.Media.DrawingContext</code>成头绘制内容，才会使用这种方法。FrameworkElement类为那些不打算与用户进行交互的元素提供了一些基本的属性和事件</td>
</tr>
<tr>
<td>Control</td>
<td><strong>当从头开始创建控件时，这是最常用的起点。该类是所有用户交互小组讲的基类。</strong>Control类添加了用于设置背景、前景、字体和内容对其方式的属性。控件类还为自身设置了Tab顺序(通过IsTabStop属性)，并且引入了鼠标双击功能(通过MouseDoubleClick和PreviewMouseDoubleClick事件)。但最重要的是，Control类定义了<code>Teamplate</code>属性，为了得到武义县的灵活性，该属性允许使用自定义元素树替换其外观</td>
</tr>
<tr>
<td>ContentControl</td>
<td>这是能够显示单一内容的控件的基类。显示的内容可以是元素或结合使用模板的自定义对象(内容通过Content属性设置，并且可以通过ContentTemplate属性提供可选的模板)。许多控件都封装了特定的、类型在一定范围内的内容(例如，文本框中的文本字符串)。因为这些控件不支持所有元素，所以它们不是内容控件</td>
</tr>
<tr>
<td>UserControl</td>
<td>这是可使用设计视图进行配置的内容控件。尽管用户控件和普通的内容控件是不同的，但当希望在多个窗口中快速重用用户界面中的不变模块时(而不是创建真正的能在不同应用程序之间转移的独立控件)，通常使用该基类</td>
</tr>
<tr>
<td>ItemsControl或Selector</td>
<td>ItemsControl是封装项列表的控件的基类，当不支持选择，而Selector类是支持选择的控件的更具体的基类。创建自定义控件不经常使用这些类，因为ListBox、ListView以及TreeView控件的数据绑定特性提供了很大的灵活性</td>
</tr>
<tr>
<td>Panel</td>
<td>该类是具有布局逻辑控件的基类。布局控件能够包含多个子元素，并根据特定的布局语义安排这些子元素。通常，面板提供了用于设置子元素的附加属性，配置如何安排子元素</td>
</tr>
<tr>
<td>Decorator</td>
<td>封装其他元素的元素的基类，并且提供了一种图形效果或特定的功能。两个明显的例子是Border和Viewbox，其中Border控件在元素的周围绘制线条、Viewbox控件使用变换动态缩放其内容。其他装饰元素包括为普通控件提供熟悉边框和背景色的装饰类</td>
</tr>
<tr>
<td>特殊控件类</td>
<td>如果希望改进现有控件，可直接继承该控件，例如，可创建具有内置验证逻辑的TextBox控件。然而，在采取这一步之前，应当首先分析是否可通过事件处理代码或单独的组件达到同一目的。这两种方法都可使自定义逻辑和控件相分离，从而在其他控件中重用</td>
</tr>
</tbody></table>
<center>元素和控件基类</center>

<img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240727165055.png" width="50%"/>

<div class="note info flat"><p>&emsp;&emsp;尽管可创建会控件的自定义元素，当在WPF中创建的大部分自定义元素都是控件——也就是说，它们能够接收焦点，并能与用户的按键操作和鼠标操作进行交互。所以在WPF开发领域，术语“自定义元素”和“自定义控件”有时互换使用。</p>
</div>

<h2 id="构建基本的用户控件"><a href="#构建基本的用户控件" class="headerlink" title="构建基本的用户控件"></a>构建基本的用户控件</h2><blockquote>
<p>接下来的示例中，首先创建一个基本的颜色拾取器</p>
</blockquote>
<p>&emsp;&emsp;可为颜色拾取器创建自定义对话框。但如果希望创建能集成进不同窗口的颜色拾取器，使用自定义控件是更好的选择。最简单的自定义控件类型是用户控件，当设计窗口或页面时通过用户控件可以使用相同的方式组装多个元素。因为仅通过直接组合现有控件并添加功能并不能实现颜色拾取器，所以用户控件看起来是更合理的选择。</p>
<h3 id="定义依赖项属性"><a href="#定义依赖项属性" class="headerlink" title="定义依赖项属性"></a>定义依赖项属性</h3><p>&emsp;&emsp;创建颜色拾取器的第一步是为自定义控件库添加用户控件。当添加用户控件后，Visual Studio会创建XAML标记我文件和响应的包含初始化代码与事件处理代码的自定义类。这与创建新的窗口或页面是相同的——唯一的区别在于顶级容器是UserControl类：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">ColorPicker</span> : <span class="title">System.Windows.Controls.UserControl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ColorPicker</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InitializeComponent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;最简单的起点是设计用户控件对外界公开的公共接口。换句话说，就是设计控件使用者(使用控件的应用程序)使用的与颜色拾取器进行交互的属性、方法和事件。<br>&emsp;&emsp;最基本的细节是 Color属性——毕竟，颜色拾取器不过是用于显示和选择颜色值的特定工为支持 WPF 特性，如数据绑定、样式以及动画，控件的可写属性几乎都是依赖项属性。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">ColorPicker</span> : <span class="title">UserControl</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ColorPicker</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InitializeComponent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Color Color</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> (Color)GetValue(ColorProperty); &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; SetValue(ColorProperty, <span class="keyword">value</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty ColorProperty =</span><br><span class="line">        DependencyProperty.Register(<span class="string">&quot;Color&quot;</span>, <span class="keyword">typeof</span>(Color), <span class="keyword">typeof</span>(ColorPicker), <span class="keyword">new</span> PropertyMetadata(Colors.Black, OnColorChanged));</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnColorChanged</span>(<span class="params">DependencyObject d, DependencyPropertyChangedEventArgs e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Color newColor = (Color)e.NewValue;</span><br><span class="line">        </span><br><span class="line">        ColorPicker colorPicker = (ColorPicker)d;</span><br><span class="line">        colorPicker.Red = newColor.R;</span><br><span class="line">        colorPicker.Green = newColor.G;</span><br><span class="line">        colorPicker.Blue = newColor.B;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">byte</span> Red</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> (<span class="built_in">byte</span>)GetValue(RedProperty); &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; SetValue(RedProperty, <span class="keyword">value</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty RedProperty =</span><br><span class="line">        DependencyProperty.Register(<span class="string">&quot;Red&quot;</span>, <span class="keyword">typeof</span>(<span class="built_in">byte</span>), <span class="keyword">typeof</span>(ColorPicker), <span class="keyword">new</span> PropertyMetadata(OnColorRGBChanged));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">byte</span> Green</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> (<span class="built_in">byte</span>)GetValue(GreenProperty); &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; SetValue(GreenProperty, <span class="keyword">value</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty GreenProperty =</span><br><span class="line">        DependencyProperty.Register(<span class="string">&quot;Green&quot;</span>, <span class="keyword">typeof</span>(<span class="built_in">byte</span>), <span class="keyword">typeof</span>(ColorPicker), <span class="keyword">new</span> PropertyMetadata(OnColorRGBChanged));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">byte</span> Blue</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> (<span class="built_in">byte</span>)GetValue(BlueProperty); &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; SetValue(BlueProperty, <span class="keyword">value</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty BlueProperty =</span><br><span class="line">        DependencyProperty.Register(<span class="string">&quot;Blue&quot;</span>, <span class="keyword">typeof</span>(<span class="built_in">byte</span>), <span class="keyword">typeof</span>(ColorPicker), <span class="keyword">new</span> PropertyMetadata(OnColorRGBChanged));</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnColorRGBChanged</span>(<span class="params">DependencyObject d, DependencyPropertyChangedEventArgs e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ColorPicker colorPicker = (ColorPicker)d;</span><br><span class="line">        Color color = colorPicker.Color;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e.Property == RedProperty)</span><br><span class="line">            color.R = (<span class="built_in">byte</span>)e.NewValue;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (e.Property == GreenProperty)</span><br><span class="line">            color.G = (<span class="built_in">byte</span>)e.NewValue;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (e.Property == BlueProperty)</span><br><span class="line">            color.B = (<span class="built_in">byte</span>)e.NewValue;</span><br><span class="line"></span><br><span class="line">        colorPicker.Color = color;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;尽管很明显，但当各个属性试图改变其他属性时，<strong>上面的代码不会引起一系列无休止的调用。因为 WPF 不允许重新进入属性变化回调函数。</strong>例如，如果改变Color 属性，就会触发OnColorChanged( )方法。0nColorChanged( )方法会修改 Red、Green 以及 Blue 属性，从而触发OnColorRGBChanged( )回调方法三次(每个属性触发一次)。然而，OnColorRGBChanged( )方法不会再次触发 OnColorChanged( )方法。</p>
<h3 id="定义路由事件"><a href="#定义路由事件" class="headerlink" title="定义路由事件"></a>定义路由事件</h3><p>&emsp;&emsp;您可能还希望添加路由事件，当发生一些事情时用于通知控件使用者。在颜色拾取器示例中，当颜色发生变化后，触发一个事件是很有用处的。尽管可将这个事件定义为普通的.NET事件，但使用路由事件可提供事件冒泡和隧道特性，从而可在更高层次的父元素(如包含窗口)中处理事件。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">OnColorChanged</span>(<span class="params">DependencyObject d, DependencyPropertyChangedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    Color newColor = (Color)e.NewValue;</span><br><span class="line">    Color oldColor = (Color)e.OldValue;</span><br><span class="line"></span><br><span class="line">    ColorPicker colorPicker = (ColorPicker)d;</span><br><span class="line">    colorPicker.Red = newColor.R;</span><br><span class="line">    colorPicker.Green = newColor.G;</span><br><span class="line">    colorPicker.Blue = newColor.B;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// +++</span></span><br><span class="line">    RoutedPropertyChangedEventArgs&lt;Color&gt; args = <span class="keyword">new</span> RoutedPropertyChangedEventArgs&lt;Color&gt;(oldColor, newColor);</span><br><span class="line">    args.RoutedEvent = ColorPicker.ColorChangedEvent;</span><br><span class="line"></span><br><span class="line">    colorPicker.RaiseEvent(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> RoutedEvent ColorChangedEvent =</span><br><span class="line">    EventManager.RegisterRoutedEvent(<span class="string">&quot;ColorChanged&quot;</span>, RoutingStrategy.Bubble, <span class="keyword">typeof</span>(RoutedPropertyChangedEventHandler&lt;Color&gt;), <span class="keyword">typeof</span>(ColorPicker));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义事件后，需要创建标准的&gt;NET事件封装器来公开事件。事件封装器可用于关联和删除事件监听程序</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">event</span> RoutedPropertyChangedEventHandler&lt;Color&gt; ColorChanged</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">add</span> &#123; AddHandler(ColorChangedEvent, <span class="keyword">value</span>); &#125;</span><br><span class="line">    <span class="keyword">remove</span></span><br><span class="line">    &#123;</span><br><span class="line">        RemoveHandler(ColorChangedEvent, <span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;不一定要为事件签名创建新的委托，有时可重用已经存在的委托。两个有用的委托是<code>ReoutedEventHandler(用于不带有额外信息的路由事件)</code>和<code>RoutedPropertyChangedEventHandler(用于提供属性发生变化之后的旧值和新值的路由事件)</code>。上例中使用的<code>RoutedPropertyChangedEventHandler</code>委托，是被类型参数化了的泛型委托。所以，可为任何属性数据类型使用该委托，而不会牺牲类型安全功能。</p>
<h3 id="添加标记"><a href="#添加标记" class="headerlink" title="添加标记"></a>添加标记</h3><p>&emsp;&emsp;现在已经定义好用户控件的公有结构，需要做的所有工作就是创建控件外观的标记。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">UserControl</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Class</span>=<span class="string">&quot;CustomControlLibrary.ColorPicker&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:d</span>=<span class="string">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:local</span>=<span class="string">&quot;clr-namespace:CustomControlLibrary&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:mc</span>=<span class="string">&quot;http://schemas.openxmlformats.org/markup-compatibility/2006&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Name</span>=<span class="string">&quot;colorPicker&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">d:DesignWidth</span>=<span class="string">&quot;200&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">mc:Ignorable</span>=<span class="string">&quot;d&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Grid.RowDefinitions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Grid.RowDefinitions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Grid.ColumnDefinitions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ColumnDefinition</span> <span class="attr">Width</span>=<span class="string">&quot;*&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ColumnDefinition</span> <span class="attr">Width</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Grid.ColumnDefinitions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Slider</span></span></span><br><span class="line"><span class="tag">            <span class="attr">x:Name</span>=<span class="string">&quot;sliderRed&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Maximum</span>=<span class="string">&quot;255&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Minimum</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Value</span>=<span class="string">&quot;&#123;Binding ElementName=colorPicker, Path=Red&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Slider</span></span></span><br><span class="line"><span class="tag">            <span class="attr">x:Name</span>=<span class="string">&quot;sliderGreen&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Grid.Row</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Maximum</span>=<span class="string">&quot;255&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Minimum</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Value</span>=<span class="string">&quot;&#123;Binding ElementName=colorPicker, Path=Green&#125;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Slider</span></span></span><br><span class="line"><span class="tag">            <span class="attr">x:Name</span>=<span class="string">&quot;sliderBlue&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Grid.Row</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Maximum</span>=<span class="string">&quot;255&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Minimum</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Value</span>=<span class="string">&quot;&#123;Binding ElementName=colorPicker, Path=Blue&#125;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Rectangle</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Grid.RowSpan</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Grid.Column</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Width</span>=<span class="string">&quot;50&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Stroke</span>=<span class="string">&quot;Black&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">StrokeThickness</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Rectangle.Fill</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">SolidColorBrush</span> <span class="attr">Color</span>=<span class="string">&quot;&#123;Binding ElementName=colorPicker, Path=Color&#125;&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Rectangle.Fill</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Rectangle</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">UserControl</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;用于用户控件的标记和无外观控件的控件模板扮演相同的角色。如果希望使标记中的一细节是可配置的，可使用将它们连接到控件属性的绑定表达式。例如，目前Rectangle 元素的宽度被固定为 50个单位。然而，可使用数据绑定表达式从用户控件的依赖项属性中提取数值来代替这些细节。这样，控件使用者可通过修改属性来选择不同的宽度。同样，可使画颜色和宽度也是可变的。<strong>然而，如果希望使控件具有真正的灵活性，最好创建无外观的控件，并在模板中定义标记，</strong>如稍后所述。</p>
<div class="note danger no-icon modern"><p>推荐在UserControl中采用RelativeSource绑定依赖项属性</p>
</div>

<p>&emsp;&emsp;在此演示的示例中，为顶级的 UserControl 控件指定了名称(colorPicker)，从而可以直接编写绑定到自定义用户控件类中属性的数据绑定表达式。然而，这种技术导致了一个明显的问题。当在窗口(或页面)中创建用户控件的实例并为之指定新名称时，会发生什么情况呢?<br>&emsp;&emsp;幸运的是，这种情况可以工作，不会出现问题，因为用户控件在包含它的窗口之前执行初始化。首先初始化用户控件，并连接它的数据绑定。接下来初始化窗口，并且在窗口标记中设置的名称被应用到用户控件。窗口中的数据绑定表达式和事件处理程序现在可使用在窗口中定义的名称访问用户控件，而且所有工作都如您所期望的那样进行。<br>&emsp;&emsp;尽管这听来简单，但如果使用代码检查 UserControl.Name 属性，可能会注意到一些奇怪的问题。例如，如果在用户控件的某个事件处理程序中检查Name 属性，将看到在窗口中定义的新名称。类似地，如果没有在窗口标记中设置名称，用户控件会继续保留来自用户控件标记的名称。如果在窗口代码中检查Name属性，就会看到这个名称。<br>&emsp;&emsp;虽然这些奇怪的事情并不表示存在问题，但更好的方法是避免在用户控件的标记中命名用户控件，并使用 Bimding.RelativeSource 属性查找元素树，直到找到 UserControl 父元素。下面是完成该工作的更长一些的语法:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Slider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Name</span>=<span class="string">&quot;sliderRed&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Maximum</span>=<span class="string">&quot;255&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Minimum</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Value</span>=<span class="string">&quot;&#123;Binding Path=Red, RelativeSource=&#123;RelativeSource Mode=FindAncestor, AncestorType=&#123;x:Type UserControl&#125;&#125;&#125;&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="使用控件"><a href="#使用控件" class="headerlink" title="使用控件"></a>使用控件</h3><p>&emsp;&emsp;</p>
<div class="tabs" id="usecolorpicker"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="usecolorpicker-1">MainWindow.xaml</button><button type="button" class="tab " data-href="usecolorpicker-2">MainWindow.xaml.cs</button></ul><div class="tab-contents"><div class="tab-item-content active" id="usecolorpicker-1"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Window</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Class</span>=<span class="string">&quot;WpfApp.MainWindow&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:d</span>=<span class="string">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:lib</span>=<span class="string">&quot;clr-namespace:CustomControlLibrary;assembly=CustomControlLibrary&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:local</span>=<span class="string">&quot;clr-namespace:WpfApp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:r</span>=<span class="string">&quot;clr-namespace:ResourceLibrary;assembly=ResourceLibrary&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Title</span>=<span class="string">&quot;MainWindow&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Width</span>=<span class="string">&quot;375&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Height</span>=<span class="string">&quot;240&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lib:ColorPicker</span> <span class="attr">ColorChanged</span>=<span class="string">&quot;ColorPicker_ColorChanged&quot;</span> <span class="attr">Color</span>=<span class="string">&quot;Beige&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextBlock</span></span></span><br><span class="line"><span class="tag">            <span class="attr">x:Name</span>=<span class="string">&quot;lblColor&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">HorizontalAlignment</span>=<span class="string">&quot;Center&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">VerticalAlignment</span>=<span class="string">&quot;Bottom&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Window</span>&gt;</span></span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="usecolorpicker-2"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">MainWindow</span> : <span class="title">Window</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MainWindow</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        InitializeComponent();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ColorPicker_ColorChanged</span>(<span class="params"><span class="built_in">object</span> sender, RoutedPropertyChangedEventArgs&lt;System.Windows.Media.Color&gt; e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (lblColor != <span class="literal">null</span>)</span><br><span class="line">            lblColor.Text = <span class="string">&quot;The new color is &quot;</span> + e.NewValue.ToString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>


<h3 id="命令支持"><a href="#命令支持" class="headerlink" title="命令支持"></a>命令支持</h3><p>&emsp;&emsp;许多控件具有命令支持。可使用以下两种方法为自定义控件添加命令支持：</p>
<ul>
<li>添加将控件链接到特定命令的命令绑定。通过这种方式，控件可以响应命令，而且不需要借助于任何外部代码</li>
<li>为命令创建新的<code>ReoutedUICommand</code>对象，作为自定义控件的静态字段。然后为这个命令对象添加命令绑定。这种方法可使自定义控件自动支持没有在基本命令类集合中定义的命令</li>
</ul>
<p>&emsp;&emsp;在颜色拾取器中为了支持Undo功能，需要使用成员字段跟踪以前选择的颜色：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ColorPicker</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    InitializeComponent();</span><br><span class="line"></span><br><span class="line">    SetUpCommands();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetUpCommands</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Set up command bindings.</span></span><br><span class="line">    CommandBinding binding = <span class="keyword">new</span> CommandBinding(ApplicationCommands.Undo, UndoCommand_Executed, UndoCommand_CanExecute); ;</span><br><span class="line">    <span class="keyword">this</span>.CommandBindings.Add(binding);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UndoCommand_Executed</span>(<span class="params"><span class="built_in">object</span> sender, ExecutedRoutedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_previousColor != <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">this</span>.Color = (Color)_previousColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">UndoCommand_CanExecute</span>(<span class="params"><span class="built_in">object</span> sender, CanExecuteRoutedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    e.CanExecute = _previousColor.HasValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="更可靠的命令"><a href="#更可靠的命令" class="headerlink" title="更可靠的命令"></a>更可靠的命令</h4><p>&emsp;&emsp;前面描述的技术是将命令链接到控件的相当合理的方法，但这不是在WPF元素和专业控件中使用的技术。<strong>这些元素使用更可靠的方法，并使用<code>CommandManager.RegisterClassCommandBinding()</code>方法关联静态的命令处理程序。</strong></p>
<p>&emsp;&emsp;上一个示例中样式的实现存在问题：<strong>使用<code>CommandBindings</code>集合。这使得命令比较脆弱，因为客户可自由地修改<code>CommandBindings</code>集合。而使用<code>RegisterClassCommandBinding()</code>方法无法做到这一点。</strong>WPF控件使用的就是这种方法。</p>
<p>&emsp;&emsp;这种技术非常简单。不在实例构造函数中创建命令绑定，而<strong>必须在静态构造函数中创建命令绑定</strong>，使用如下所示的代码:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">ColorPicker</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    CommandManager.RegisterClassCommandBinding(</span><br><span class="line">        <span class="keyword">typeof</span>(ColorPicker),</span><br><span class="line">        <span class="keyword">new</span> CommandBinding(</span><br><span class="line">            ApplicationCommands.Undo,</span><br><span class="line">            UndoCommand_Executed,</span><br><span class="line">            UndoCommand_CanExecute</span><br><span class="line">        )</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">UndoCommand_Executed</span>(<span class="params"><span class="built_in">object</span> sender, ExecutedRoutedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ColorPicker colorPicker = (ColorPicker)sender;</span><br><span class="line">    colorPicker.Color = (Color)colorPicker._previousColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">UndoCommand_CanExecute</span>(<span class="params"><span class="built_in">object</span> sender, CanExecuteRoutedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ColorPicker colorPicker = (ColorPicker)sender;</span><br><span class="line">    e.CanExecute = colorPicker._previousColor.HasValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;此外，这种技术不局限于命令。<strong>如果希望将事件处理逻辑硬编码到自定义控件，可通过<code>EventManager.RegisterClassHandler()</code>方法使用类事件处理程序。类事件处理程序总在实例事件处理程序之前调用，从而允许开发人员很容易地抑制事件。</strong></p>
<h3 id="深入分析用户控件"><a href="#深入分析用户控件" class="headerlink" title="深入分析用户控件"></a>深入分析用户控件</h3><p>&emsp;&emsp;用户控件提供了一种非常简单，但是有一定限制的创建自定义控件的方法。为理解其中的原因，深入分析用户控件的工作原理是很有帮助的。<br>&emsp;&emsp;在后台，<code>UserControl</code>类的工作方式和其分类<code>ContentControl</code>非常类似。实际上，只有几个重要的区别：</p>
<ul>
<li><code>UserControl 类改变了一些默认值</code>。即该类<strong>将 IsTabStop 和 Focusable 属性设置为 false</strong>(从而在Tab 顺序中没有占据某个单独的位置)，并<strong>将HorizontalAlignment和 VerticalAlignment 属性设置为 Stretch</strong>(而非 Left 或 Top)，从而可以填充可用空间。</li>
<li><code>UserControl 类应用了一个新的控件模板</code>，该模板由包含 ContentPresenter 元素的 Border元素组成。ContentPresenter元素包含了用标记添加的内容。</li>
<li><code>UserControl 类改变了路由事件的源。</code>当事件从用户控件内的控件向用户控件外的元素冒泡或隧道路由时，事件源变为指向用户控件而不是原始元素。这提供了更好的封装性(例如，如果在包含颜色拾取器的布局容器中处理 UIElement,MouseLeftButtonDown 事件，当单击内部的 Rectangle 元素时将接收到事件。然而，这个事件的源不是 Rectangle 元素，而是包含 Rectangle 元素的 ColorPicker 对象。如果作为普通的内容控件创建相同的颜色拾取器，情况就不同了--您需要在控件中拦截事件、处理事件并且重新引发事件)。</li>
</ul>
<p>&emsp;&emsp;<code>用户控件与其他类型的自定义控件之间最重要的区别是设计用户控件的方法。</code>与所有控件样，用户控件有控件模板。然而，很少改变控件模板——反而，将作为自定义用户控件类的一部分提供标记，并且当创建了控件后，会使用InitializeComponent()方法处理这个标记。另一方面，无外观控件是没有标记的——需要的所有内容都在模板中。</p>
<blockquote>
<p>简单的UserControl模板</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ControlTemplate</span> <span class="attr">TargetType</span>=<span class="string">&quot;&#123;x:Type UserControl&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Border</span></span></span><br><span class="line"><span class="tag">        <span class="attr">Padding</span>=<span class="string">&quot;&#123;TemplateBinding Control.Padding&#125;&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">Background</span>=<span class="string">&quot;&#123;TemplateBinding Panel.Background&#125;&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">BorderBrush</span>=<span class="string">&quot;&#123;TemplateBinding Border.BorderBrush&#125;&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">BorderThickness</span>=<span class="string">&quot;&#123;TemplateBinding BorderThickness&#125;&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">SnapsToDevicePixels</span>=<span class="string">&quot;True&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ContentPresenter</span></span></span><br><span class="line"><span class="tag">            <span class="attr">HorizontalAlignment</span>=<span class="string">&quot;&#123;TemplateBinding Control.HorizontalContentAlignment&#125;&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">VerticalAlignment</span>=<span class="string">&quot;&#123;TemplateBinding Control.VerticalContentAlignment&#125;&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Content</span>=<span class="string">&quot;&#123;TemplateBinding ContentControl.Content&#125;&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">ContentTemplate</span>=<span class="string">&quot;&#123;TemplateBinding ContentControl.ContentTemplate&#125;&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">SnapsToDevicePixels</span>=<span class="string">&quot;&#123;TemplateBinding UIElement.SnapsToDevicePixels&#125;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Border</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ControlTemplate</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;从技术角度看，可改变用户控件的模板。实际上，只需要进行很少的调整，就可以将所有标记移到模板中。但确实没有理由采取该方法——如果希望得到更灵活的控件，使可视化外观和由自定义控件类定义的接口分开，创建无外观的自定义控件可能会更好一些。</p>
<h2 id="创建无外观控件"><a href="#创建无外观控件" class="headerlink" title="创建无外观控件"></a>创建无外观控件</h2><p>&emsp;&emsp;<strong>用户控件的目标是提供增补控件模板的设计表面，提供一种定义控件的快速方法，代价是失去了将来的灵活性。</strong>如果喜欢用户控件的功能，但需要修改其可视化外观，使用这种方法就有问题了。例如，设想希望使用相同的颜色拾取器，但希望使用不同的“皮肤”，将其更好地融合到已有的应用程序窗口中。可以通过样式来改变用户控件的某些方面，但该控件的一些部分是在内部锁定的，并硬编码到标记中。例如，无法将预览矩形移动到滑动条的左边。</p>
<p>&emsp;&emsp;<strong>解决方法是创建无外观控件——继承自控件基类，但没有设计表面的控件。</strong>相反，这个控件将其标记放到默认模板中，可替换默认模板而不会影响控件逻辑。</p>
<h3 id="修改颜色拾取器的代码"><a href="#修改颜色拾取器的代码" class="headerlink" title="修改颜色拾取器的代码"></a>修改颜色拾取器的代码</h3><p>&emsp;&emsp;将颜色拾取器改成无外观的，只需要修改类的声明，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">ColorPicker</span> : <span class="title">System.Windows.Controls.Control</span></span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;在这个示例中，<strong>ColorPicker类继承自Control类。继承自FrameworkElement 类是不合适的因为颜色拾取器允许与用户进行交互，而且其他高级的类不能准确地描述颜色拾取器的行为例如，颜色拾取器不允许在内部嵌套其他内容，所以继承自ContentControl类也是不合适的。</strong></p>
<p>&emsp;&emsp;ColorPicker类中的代码与用于用户控件的代码是相同的(除了必须删除构造函数中的ImitializeComponent()方法调用)。可使用相同的方法定义依赖项属性和路由事件。<code>唯一的区别是需要通知 WPF，将为控件类提供新样式</code>。该样式将提供新的控件模板(如果不执行该步骤，将继续使用在基类中定义的模板)。</p>
<blockquote>
<p>为通知WPF正在提供新的样式，需要在自定义控件类的静态构造函数中调用<code>DefaultStyleKeyProperty.OverrideMetadata()</code>，该属性是为自定义控件定义默认央视的依赖项属性。需要的代码如下所示：</p>
</blockquote>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DefaultStyleKeyProperty.OverrideMetadata(</span><br><span class="line">    <span class="keyword">typeof</span>(ColorPicker),</span><br><span class="line">    <span class="keyword">new</span> FrameworkPropertyMetadata(<span class="keyword">typeof</span>(ColorPicker))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;如果希望使用其他控件类的模板，可提供不同的类型，当几乎总是为每隔自定义控件创建特定的样式。</p>
<h3 id="修改颜色拾取器的标记"><a href="#修改颜色拾取器的标记" class="headerlink" title="修改颜色拾取器的标记"></a>修改颜色拾取器的标记</h3><p>&emsp;&emsp;添加对<code>OverrideMetadata()</code>方法的调用后，只需要插入正确的样式。需要将样式房子啊名为<code>Generic.xaml</code>的资源字典中，该资源字典必须放在项目文件夹的<code>Themes</code>子文件夹中。这样，该样式就会被识别为自定义控件的默认样式。下面列出添加<code>Generic.xaml</code>文件的具体步骤：</p>
<ol>
<li>在<em>Solution Explorer</em>中右击类库项目，并选择<em>Add|New Folder</em>菜单项</li>
<li>将新文件夹命名为<code>Themes</code></li>
<li>右击<em>Themes</em>文件夹，并选择<em>Add|New Item</em>菜单项</li>
<li>在<em>Add New Item</em>对话框中选择<em>Resource Dictionary File</em>，输入名称<code>Generic.xaml</code>，并单击<em>Add</em>按钮</li>
</ol>
<blockquote>
<p>主题专用的样式和Generic.xaml文件</p>
</blockquote>
<p><em>&emsp;&emsp;您已经看到，ColorPicker从generic.xaml 文件获取默认的控件模板，generic.xaml 文件位于Themes 项目文件夹中。这个稍有些怪异的约定实际上是旧式WPF 功能的一部分:Windows 主题支持<br>&emsp;&emsp;Windows 主题支持的初衷是使开发人员创建控件的自定义版本来匹配不同的 Windows 主题。Wimndows XP 计算机使用主题来控制 Windows 应用程序的总体颜色方案，Windows 主题支持在此类计算机上最有意义。Windows Vista 引入了 Aero 主题，该主题有效地取代了旧的主题选项，后续 Widows 版本尚未改变这种事态，因此人们现在普遍忽略了原本就不怎么常用的WPF 中的 Windows主题功能。<br>&emsp;&emsp;不过，当今的 WPF 应用程序开发人员总是使用 generic.xam 文件来设置默认的控件样式generic.xaml 文件的名称(及其所在的 Themes 文件夹)被延用下来。</em></p>
<p>&emsp;&emsp;通常，自定义控件库会包含几个控件。为了保持它们的样式相互独立以便编辑，<code>Generic.xaml</code>文件通常使用资源字典合并功能。下面的标记显示了<code>Generic.xaml</code>文件，该文件成<code>ColorPicker.xaml</code>资源字典中提取资源，该资源字典位于<em>CustomControls</em>控件库的<em>Themes</em>子文件夹中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ResourceDictionary</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ResourceDictionary.MergedDictionaries</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ResourceDictionary</span> <span class="attr">Source</span>=<span class="string">&quot;/CustomControlLibrary;component/Themes/ColorPicker.xaml&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ResourceDictionary.MergedDictionaries</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">ResourceDictionary</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;自定义的控件样式必须使用<code>TargetType</code>特性将自身自动关联到颜色拾取器。下面是<em>ColorPicker.xaml</em>文件中标记的基本结构：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ResourceDictionary</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">xmlns:local</span>=<span class="string">&quot;clr-namespace:CustomControlLibrary&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Style</span> <span class="attr">TargetType</span>=<span class="string">&quot;&#123;x:Type local:ColorPicker&#125;&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">Style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ResourceDictionary</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;可使用样式设置控件类中的任意属性（无论是继承自基类的属性还是新增属性）。但在此，样式最有用的任务是应用新模板，新模板定义了控件的默认可视化外观。<br>&emsp;&emsp;很容易就能将普通标记（如颜色拾取器使用的标记）转换到控件模板中。但要注意以下几点：</p>
<ul>
<li>当创建链接到父控件类属性的绑定表达式时，不能使用<code>ElementName</code>属性。而需要使用<code>RelativeSource</code>属性指示希望绑定到父控件。如果单向绑定完全满足需要，通常可以使用轻量级的<code>TeamplateBinding</code>标记表达式，而不需要使用功能完备的数据绑定。</li>
<li>不能在控件模板中关联事件处理程序。相反，需要为元素提供能够识别的名称，并在控件构造函数中通过代码为它们关联事件处理程序。</li>
<li>除非希望关联事件处理程序或通过代码与它们进行交互，否则不要在控件模板中命名元素。当命名希望使用的元素时，使用“<code>PART_元素名</code>”的形式进行命名</li>
</ul>
<blockquote>
<p>遵循上面几点，可为颜色拾取器创建以下模板：</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ResourceDictionary</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:local</span>=<span class="string">&quot;clr-namespace:CustomControlLibrary&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Style</span> <span class="attr">TargetType</span>=<span class="string">&quot;&#123;x:Type local:ColorPicker&#125;&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Setter</span> <span class="attr">Property</span>=<span class="string">&quot;Template&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Setter.Value</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ControlTemplate</span> <span class="attr">TargetType</span>=<span class="string">&quot;&#123;x:Type local:ColorPicker&#125;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Grid.RowDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">Grid.RowDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Grid.ColumnDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">ColumnDefinition</span> <span class="attr">Width</span>=<span class="string">&quot;*&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">ColumnDefinition</span> <span class="attr">Width</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">Grid.ColumnDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Slider</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Maximum</span>=<span class="string">&quot;255&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Minimum</span>=<span class="string">&quot;0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Value</span>=<span class="string">&quot;&#123;Binding Red, RelativeSource=&#123;RelativeSource TemplatedParent&#125;&#125;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Slider</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Grid.Row</span>=<span class="string">&quot;1&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Maximum</span>=<span class="string">&quot;255&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Minimum</span>=<span class="string">&quot;0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Value</span>=<span class="string">&quot;&#123;Binding Green, RelativeSource=&#123;RelativeSource TemplatedParent&#125;&#125;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Slider</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Grid.Row</span>=<span class="string">&quot;2&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Maximum</span>=<span class="string">&quot;255&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Minimum</span>=<span class="string">&quot;0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Value</span>=<span class="string">&quot;&#123;Binding Blue, RelativeSource=&#123;RelativeSource TemplatedParent&#125;&#125;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Rectangle</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Grid.RowSpan</span>=<span class="string">&quot;3&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Grid.Column</span>=<span class="string">&quot;1&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Width</span>=<span class="string">&quot;50&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Stroke</span>=<span class="string">&quot;Black&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">StrokeThickness</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Rectangle.Fill</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">SolidColorBrush</span> <span class="attr">Color</span>=<span class="string">&quot;&#123;Binding Color, RelativeSource=&#123;RelativeSource TemplatedParent&#125;&#125;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Rectangle.Fill</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">Rectangle</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ControlTemplate</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Setter.Value</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Setter</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">Style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ResourceDictionary</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;用 TemplateBinding 扩展替换一些绑定表达式。其他一些绑定表达式仍使用 Binding 扩展，但将 RelativeSource 设置为指向模板的父元素(自定义控件)。<strong>尽管TemplateBinding 和将 RelativeSource 属性设置为 TemplatedParent 值的 Binding 的作用相同从自定义控件的属性中提取数据——但是使用量级更轻的 TemplateBinding 总是合适的。</strong>如果需要双向绑定(与滑动条一样)或绑定到继承自Freezable的类(如 SolidColorBrush 类)的属性TemplateBinding 就不能工作了。</p>
<h3 id="精简控件模板"><a href="#精简控件模板" class="headerlink" title="精简控件模板"></a>精简控件模板</h3><p>&emsp;&emsp;现在，所有希望提供自定义模板的控件使用者都必须添加大量绑定表达式，以确保控制能够继续工作。这并不难，但很繁琐。另一种选择是，在控件自身的初始化代码中配置所有绑定表达式。这样，模板就不需要指定这些细节了。</p>
<div class="note info flat"><p>&emsp;&emsp;当为构成自定义控件的元素关联事件处理程序时使用的是相同的技术。通过代码关联事件处理程序，而不是在模板中使用事件特性</p>
</div>

<h4 id="添加部件名称"><a href="#添加部件名称" class="headerlink" title="添加部件名称"></a>添加部件名称</h4><p>&emsp;&emsp;为了让这一系统能够工作，代码要能找到所需的元素。WPF控件通过名称定位它们需要的元素。所以，元素的名称就成自定义控件公有结构的一部分，而且需要恰当的描述性名称。根据约定，这些名称以<code>PART_开头</code>，后跟元素名称。元素的名称的首字母要大写，就像属性名称。对于需要的元素名称，<code>PART_RedSlider</code>是适合的选择，而<em>PART_sldRed、PART_redSlider</em>以及<em>RedSlider</em>等名称都不合适。</p>
<p>&emsp;&emsp;下面的标记样式了如何通过删除三个滑动条的<em>Value</em>属性的绑定表达式，并为三个滑动条添加*<code>PART_名称</code>*，从而为通过代码设置绑定做好准备：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Slider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Name</span>=<span class="string">&quot;PART_RedSlider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Maximum</span>=<span class="string">&quot;255&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Minimum</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Slider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Name</span>=<span class="string">&quot;PART_GreenSlider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Grid.Row</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Maximum</span>=<span class="string">&quot;255&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Minimum</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Slider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Name</span>=<span class="string">&quot;PART_BlueSlider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Grid.Row</span>=<span class="string">&quot;2&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Maximum</span>=<span class="string">&quot;255&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Minimum</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">Rectangle</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Grid.RowSpan</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Grid.Column</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Width</span>=<span class="string">&quot;50&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Stroke</span>=<span class="string">&quot;Black&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">StrokeThickness</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Rectangle.Fill</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">SolidColorBrush</span> <span class="attr">x:Name</span>=<span class="string">&quot;PART_PreviewBrush&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Rectangle.Fill</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Rectangle</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="操作模板部件"><a href="#操作模板部件" class="headerlink" title="操作模板部件"></a>操作模板部件</h4><p>&emsp;&emsp;在初始化控件后，可连接绑定表达式，但有一种更好的方法。<strong>WPF有一个专用的<code>OnApplyTemplate()</code>方法，如果需要在模板中查找元素并关联事件处理程序或添加数据绑定表达式，应重写该方法。在该方法中，可以使用<code>GetTemplateChild()</code>方法（该方法继承自<code>FrameworkElement</code>）查找所需的元素。</strong></p>
<p>&emsp;&emsp;如果没有找到希望处理的元素，推荐的模式就不起作用。也可添加代码来检查该元素，如果元素存在，再检查类型是否正确；如果类型不正确，就引发异常（此处的想法是，不存在的元素代表有意丢失某个特定功能，但元素类型不正确代表错误）。</p>
<p>&emsp;&emsp;下面的代码演示了如何在<code>OnApplyTemplate()</code>方法中连接其中一个滑动条的数据绑定表达式：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnApplyTemplate</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnApplyTemplate();</span><br><span class="line"></span><br><span class="line">    RangeBase redSlider = GetTemplateChild(<span class="string">&quot;PART_RedSlider&quot;</span>) <span class="keyword">as</span> RangeBase;</span><br><span class="line">    <span class="keyword">if</span> (redSlider != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Bind to the Red property in the control, using a two-way binding.</span></span><br><span class="line">        Binding binding = <span class="keyword">new</span> Binding(<span class="keyword">nameof</span>(Red));</span><br><span class="line">        binding.Source = <span class="keyword">this</span>;</span><br><span class="line">        binding.Mode = BindingMode.TwoWay;</span><br><span class="line">        redSlider.SetBinding(RangeBase.ValueProperty, binding);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RangeBase greenSlider = GetTemplateChild(<span class="string">&quot;PART_GreenSlider&quot;</span>) <span class="keyword">as</span> RangeBase;</span><br><span class="line">    <span class="keyword">if</span> (greenSlider != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Bind to the Red property in the control, using a two-way binding.</span></span><br><span class="line">        Binding binding = <span class="keyword">new</span> Binding(<span class="keyword">nameof</span>(Green));</span><br><span class="line">        binding.Source = <span class="keyword">this</span>;</span><br><span class="line">        binding.Mode = BindingMode.TwoWay;</span><br><span class="line">        greenSlider.SetBinding(RangeBase.ValueProperty, binding);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    RangeBase blueSlider = GetTemplateChild(<span class="string">&quot;PART_BlueSlider&quot;</span>) <span class="keyword">as</span> RangeBase;</span><br><span class="line">    <span class="keyword">if</span> (blueSlider != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Bind to the Red property in the control, using a two-way binding.</span></span><br><span class="line">        Binding binding = <span class="keyword">new</span> Binding(<span class="keyword">nameof</span>(Blue));</span><br><span class="line">        binding.Source = <span class="keyword">this</span>;</span><br><span class="line">        binding.Mode = BindingMode.TwoWay;</span><br><span class="line">        blueSlider.SetBinding(RangeBase.ValueProperty, binding);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SolidColorBrush brush = GetTemplateChild(<span class="string">&quot;PART_PreviewBrush&quot;</span>) <span class="keyword">as</span> SolidColorBrush;</span><br><span class="line">    <span class="keyword">if</span> (brush != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        Binding binding = <span class="keyword">new</span> Binding(<span class="keyword">nameof</span>(Color));</span><br><span class="line">        binding.Source = brush;</span><br><span class="line">        binding.Mode = BindingMode.OneWayToSource;</span><br><span class="line">        <span class="keyword">this</span>.SetBinding(ColorPicker.ColorProperty, binding);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;注意，上面代码使用的是 <code>System,Windows.Controls,Primitives.RangeBase</code> 类(Slider 类继承自该类)而不是 Slider 类。因为 RangeBase 类提供了需要的最小功能——在本例中是指 Value 属性通过尽可能提高代码的通用性，控件使用者可获得更大自由。例如，现在可提供自定义模板，使用不同的派生自 RangeBase 类的控件代替颜色滑动条。</p>
<blockquote>
<p>为查看这种设计变化的优点，需要创建一个使用颜色拾取器的控件，并提供一个新的控件模板</p>
</blockquote>
<center>具有两个不同模板的颜色拾取器自定义控件</center>

<img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240728162520.png" width="50%"/>

<h4 id="记录模板部件"><a href="#记录模板部件" class="headerlink" title="记录模板部件"></a>记录模板部件</h4><p>&emsp;&emsp;良好的设计指导原则建议为控件声明添加<code>TemplatePart</code>特性，以记录在控件模板中使用了那些部件名称，以及为每个部件使用了什么类型的控件。成技术角度该，这一步不是必需的，但该文档可为其他使用自定义类的用户提供帮助（还可通过允许构建自定义控件模板的设计工具(如Expression Blend)来进行检查）。</p>
<p>&emsp;&emsp;下面是应当为<code>ColorPicker</code>控件类添加的<code>TemplatePart</code>特性：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">TemplatePart(Name = <span class="string">&quot;PART_RedSlider&quot;</span>, Type = typeof(RangeBase))</span>]</span><br><span class="line">[<span class="meta">TemplatePart(Name = <span class="string">&quot;PART_GreenSlider&quot;</span>, Type = typeof(RangeBase))</span>]</span><br><span class="line">[<span class="meta">TemplatePart(Name = <span class="string">&quot;PART_BlueSlider&quot;</span>, Type = typeof(RangeBase))</span>]</span><br><span class="line">[<span class="meta">TemplatePart(Name = <span class="string">&quot;PART_PreviewBrush&quot;</span>, Type = typeof(SolidColorBrush))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">ColorPicker</span> : <span class="title">System.Windows.Controls.Control</span></span><br><span class="line">&#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note info flat"><p>&emsp;&emsp;每个控件都有默认样式。可调用控件类静态构造函数的<code>DefaultStyleProperty.OverrideMetadata()</code>方法来指示自定义控件应使用的默认样式。否则，自定义控件将简单地使用为基类控件定义的默认样式</p>
</div>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Style style = Application.Current.FindResource(<span class="keyword">typeof</span>(Button));</span><br></pre></td></tr></table></figure>

<h2 id="支持可视化状态"><a href="#支持可视化状态" class="headerlink" title="支持可视化状态"></a>支持可视化状态</h2><p>&emsp;&emsp;ColorPicker控件是控件设计的极佳示例。因为其行为风格实话外观是精心分离的，所以其他设计人员可开发动态改变其外观的新模板。<br>&emsp;&emsp;ColorPicker 控件如此简单的一个原因是它不涉及状态。换句话说,它不根据是否具有焦点、鼠标是否在它上面悬停、是否禁用等状态区分其可视化外观。接下来的FlipPanel 自定义控件有些不同。</p>
<p>&emsp;&emsp;FlipPanel 控件背后的基本思想是，为驻留内容提供两个表面，但每次只有一个表面是可见的。为看到其他内容，需要在两个表面之间进行“翻转”。可通过控件模板定制翻转效果，但默认效果使用在前面和后面之间进行过渡的淡化效果。根据应用程序，可以使用 FlinPanel 控件把数据条目表单与一些有帮助的文档组合起来，以便为相同的数据提供一个简单或较复杂的视图，或在一个简单游戏中将问题和答案融合在一起。</p>
<p>&emsp;&emsp;可通过代码执行翻转（通过设置名为IsFlipped的属性），也可使用一个便捷的按钮来翻转面板（除非控件使用者从模板中移除了该按钮）<br>&emsp;&emsp;<em>显然，控件模板需要指定两个独立部分:FlipPanel控件的前后内容区域。然而，还有一个细节--FlipPanel控件需要一种方法在两个状态之间进行切换:翻转过的状态与未翻转过的状态。可通过为模板添加触发器来完成该工作。当单击按钮时，可使用一个触发器隐藏前面的面板并显示第二个面板，而使用另一个触发器翻转这些更改。这两个触发器都可以使用您喜欢的任何动画。但通过使用可视化状态，可向控件使用者清晰地指明这两个状态是模板的必需部分。不是为适当的属性或事件编写触发器，控件使用者只需要填充适当的状态动画。如果使用Expression Blend，该任务甚至变得更简单。</em></p>
<img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/GmN6LQGNRk.gif"/>

<h3 id="开始编写FlipPanel类"><a href="#开始编写FlipPanel类" class="headerlink" title="开始编写FlipPanel类"></a>开始编写FlipPanel类</h3><p>&emsp;&emsp;<em>FlipPanel的基本骨架非常简单。包含用户可用单一元素(最有可能是包含各种元素的布局容器)填充的两个内容区域。从技术角度看，这意味着FlipPanel 控件不是真正的面板，因为不能使用布局逻辑组织一组子元素。然而，这不会造成问题，因为FlipPanel 控件的结构是清晰直观的。FlipPanel控件还包含一个翻转按钮，用户可使用该按钮在两个不同的内容区域之间进行切换。</em></p>
<p>&emsp;&emsp;尽管可通过继承自<code>ContentControl</code>或<code>Panel</code>等控件类来创建自定义控件，但是<em>FlipPanl</em>直接继承自<code>Control</code>基类。如果不需要特定控件类的功能，这是最好的起点。不应当继承自更简单的<code>FrameworkworkElement</code>类，除非希望创建不实用标准控件和模板基础架构的元素：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlipPanel</span> : <span class="title">System.Windows.Controls.Control</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">FlipPanel</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        DefaultStyleKeyProperty.OverrideMetadata(</span><br><span class="line">            <span class="keyword">typeof</span>(FlipPanel),</span><br><span class="line">            <span class="keyword">new</span> FrameworkPropertyMetadata(<span class="keyword">typeof</span>(FlipPanel))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">object</span> FrontContent</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> (<span class="built_in">object</span>)GetValue(FrontContentProperty); &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; SetValue(FrontContentProperty, <span class="keyword">value</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty FrontContentProperty =</span><br><span class="line">        DependencyProperty.Register(</span><br><span class="line">            <span class="string">&quot;FrontContent&quot;</span>,</span><br><span class="line">            <span class="keyword">typeof</span>(<span class="built_in">object</span>),</span><br><span class="line">            <span class="keyword">typeof</span>(FlipPanel),</span><br><span class="line">            <span class="keyword">new</span> PropertyMetadata(<span class="literal">null</span>)</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">object</span> BackContent</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> (<span class="built_in">object</span>)GetValue(BackContentProperty); &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; SetValue(BackContentProperty, <span class="keyword">value</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty BackContentProperty = DependencyProperty.Register(</span><br><span class="line">        <span class="string">&quot;BackContent&quot;</span>,</span><br><span class="line">        <span class="keyword">typeof</span>(<span class="built_in">object</span>),</span><br><span class="line">        <span class="keyword">typeof</span>(FlipPanel),</span><br><span class="line">        <span class="keyword">new</span> PropertyMetadata(<span class="literal">null</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> IsFlipped</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> (<span class="built_in">bool</span>)GetValue(IsFlippedProperty); &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; SetValue(IsFlippedProperty, <span class="keyword">value</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty IsFlippedProperty = DependencyProperty.Register(</span><br><span class="line">        <span class="string">&quot;IsFlipped&quot;</span>,</span><br><span class="line">        <span class="keyword">typeof</span>(<span class="built_in">bool</span>),</span><br><span class="line">        <span class="keyword">typeof</span>(FlipPanel),</span><br><span class="line">        <span class="keyword">new</span> PropertyMetadata(<span class="literal">false</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> CornerRadius CornerRadius</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> (CornerRadius)GetValue(CornerRadiusProperty); &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; SetValue(CornerRadiusProperty, <span class="keyword">value</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty CornerRadiusProperty =</span><br><span class="line">        DependencyProperty.Register(</span><br><span class="line">            <span class="string">&quot;CornerRadius&quot;</span>,</span><br><span class="line">            <span class="keyword">typeof</span>(CornerRadius),</span><br><span class="line">            <span class="keyword">typeof</span>(FlipPanel),</span><br><span class="line">            <span class="keyword">new</span> PropertyMetadata(<span class="literal">default</span>)</span><br><span class="line">        );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="选择部件和状态"><a href="#选择部件和状态" class="headerlink" title="选择部件和状态"></a>选择部件和状态</h3><p>&emsp;&emsp;现在已经具备了基本结构，并且已经准备好确定将在控件模板中国使用的部件和状态了。显然，<code>FlipPanel</code>需要两个状态：</p>
<ul>
<li><em>正常状态</em>。该故事板确保只有前面的内容是可见的，后面的内容被翻转、淡化或移除视图。</li>
<li><em>翻转状态</em>。该故事板确保只有后面的内容是可见的，前面的内容通过动画被移出视图。</li>
</ul>
<p>&emsp;&emsp;此外，需要两个部件：</p>
<ul>
<li><em>FlipButton</em>。这是一个按钮，当单击该按钮时，将视图成前面改到后面（或成后面改到前面）。<em>FlipPanel</em>控件通过处理该按钮的事件提供该服务</li>
<li><em>FlipButtonAlternate</em>。这是一个可选元素，与<em>FlipButton</em>的工作方式相同。允许控件使用者在自定义模板中使用两种不同的方法。一种选择是使用在可翻转区域外的单个翻转按钮，另一种选择是在可翻转区域的面板两侧放置独立的翻转按钮。</li>
</ul>
<blockquote>
<p>为表明<code>FlipPanel</code>使用这些部件和状态的事实，应为自定义控件类应用<code>TemplatePart</code>特性，如下所示：</p>
</blockquote>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">TemplateVisualState(Name = <span class="string">&quot;Normal&quot;</span>, GroupName = <span class="string">&quot;ViewStates&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">TemplateVisualState(Name = <span class="string">&quot;Flipped&quot;</span>, GroupName = <span class="string">&quot;ViewStates&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">TemplatePart(Name = <span class="string">&quot;FlipButton&quot;</span>, Type = typeof(ToggleButton))</span>]</span><br><span class="line">[<span class="meta">TemplatePart(Name = <span class="string">&quot;FlipButtonAlternate&quot;</span>, Type = typeof(ToggleButton))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FlipPanel</span> : <span class="title">System.Windows.Controls.Control</span></span><br><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;FlipButton 和 FlipButtonAlternate 部件都受到限制——每个部件只能是 ToggleButton 控件或ToggleButton 派生类的实例(ToggleButton 是可单击的按钮，能够处于两个状态中的某个状态。对于FlipPanel控件，ToggleButton 的状态对应于普通的前向视图或翻转的后向视图)。</p>
<div class="note info flat"><p>&emsp;&emsp;为确保最好、最灵活的模板支持,尽可能使用最通用的元素类型。例如,除非需要 ContentControl提供的某些属性或行为，使用FrameworkElement比使用ContentControl更好。</p>
</div>


<h3 id="默认控件模板"><a href="#默认控件模板" class="headerlink" title="默认控件模板"></a>默认控件模板</h3><p>&emsp;&emsp;现在，可将这些内容投入到默认控件模板中。根元素是具有两行的Grid 面板，该面板包含内容区域(在顶行)和翻转按钮(在底行)。用两个相互重叠的 Border 元素填充内容区域，代表前面和后面的内容，但一次只显示前面或后面内容。</p>
<p>&emsp;&emsp;<em>为了填充前面和后面的内容区域，FlipPanel控件使用ContentPresenter 元素。该技术几乎和自定义按钮示例相同，只是需要两个ContentPresenter 元素，分别用于 FlipPanel 控件的前面和后面。FlipPanel控件还包含独立的 Border 元素来封装每个 ContentPresenter 元素。从而让控件使用者能通过设置FlipPanel的几个直接属性勾勒出可翻转内容区域(BorderBrushBorderThickness、Background 以及 CorerRadius)，而不是强制性地手动添加边框。</em></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ResourceDictionary</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:local</span>=<span class="string">&quot;clr-namespace:CustomControlLibrary&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Style</span> <span class="attr">TargetType</span>=<span class="string">&quot;&#123;x:Type local:FlipPanel&#125;&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Setter</span> <span class="attr">Property</span>=<span class="string">&quot;Template&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Setter.Value</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ControlTemplate</span> <span class="attr">TargetType</span>=<span class="string">&quot;&#123;x:Type local:FlipPanel&#125;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Grid.RowDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">Grid.RowDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                        <span class="comment">&lt;!--  This is the front content.  --&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Border</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">x:Name</span>=<span class="string">&quot;FrontContent&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Background</span>=<span class="string">&quot;&#123;TemplateBinding Background&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">BorderBrush</span>=<span class="string">&quot;&#123;TemplateBinding BorderBrush&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">BorderThickness</span>=<span class="string">&quot;&#123;TemplateBinding BorderThickness&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">CornerRadius</span>=<span class="string">&quot;&#123;TemplateBinding CornerRadius&#125;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">ContentPresenter</span> <span class="attr">Content</span>=<span class="string">&quot;&#123;TemplateBinding FrontContent&#125;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">Border</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                        <span class="comment">&lt;!--  This is the back content.  --&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Border</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">x:Name</span>=<span class="string">&quot;BackContent&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Background</span>=<span class="string">&quot;&#123;TemplateBinding Background&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">BorderBrush</span>=<span class="string">&quot;&#123;TemplateBinding BorderBrush&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">BorderThickness</span>=<span class="string">&quot;&#123;TemplateBinding BorderThickness&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">CornerRadius</span>=<span class="string">&quot;&#123;TemplateBinding CornerRadius&#125;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">ContentPresenter</span> <span class="attr">Content</span>=<span class="string">&quot;&#123;TemplateBinding BackContent&#125;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">Border</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                        <span class="comment">&lt;!--  This the flip button.  --&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">ToggleButton</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">x:Name</span>=<span class="string">&quot;FlipButton&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Grid.Row</span>=<span class="string">&quot;1&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Width</span>=<span class="string">&quot;19&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Height</span>=<span class="string">&quot;19&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Margin</span>=<span class="string">&quot;0,10,0,0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">RenderTransformOrigin</span>=<span class="string">&quot;0.5,0.5&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">ToggleButton.Template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">ControlTemplate</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">Ellipse</span> <span class="attr">Fill</span>=<span class="string">&quot;AliceBlue&quot;</span> <span class="attr">Stroke</span>=<span class="string">&quot;#FFA9A9A9&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">Path</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">HorizontalAlignment</span>=<span class="string">&quot;Center&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">VerticalAlignment</span>=<span class="string">&quot;Center&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Data</span>=<span class="string">&quot;M1,1.5 L4.5,5 8,1.5&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Stroke</span>=<span class="string">&quot;#FF666666&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">StrokeThickness</span>=<span class="string">&quot;2&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;/<span class="name">ControlTemplate</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">ToggleButton.Template</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">ToggleButton.RenderTransform</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">RotateTransform</span> <span class="attr">x:Name</span>=<span class="string">&quot;FlipButtonTransform&quot;</span> <span class="attr">Angle</span>=<span class="string">&quot;-90&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">ToggleButton.RenderTransform</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">ToggleButton</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">VisualStateManager.VisualStateGroups</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">VisualStateGroup</span> <span class="attr">x:Name</span>=<span class="string">&quot;ViewStates&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">VisualStateGroup.Transitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="comment">&lt;!--  统一设置相同的过渡时间  --&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="comment">&lt;!--&lt;VisualTransition GeneratedDuration=&quot;0:0:0.7&quot; /&gt;--&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="comment">&lt;!--  单独设置切换的过渡时间  --&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">VisualTransition</span> <span class="attr">GeneratedDuration</span>=<span class="string">&quot;0:0:0.7&quot;</span> <span class="attr">To</span>=<span class="string">&quot;Flipped&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                            <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;FlipButtonTransform&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;Angle&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">To</span>=<span class="string">&quot;90&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Duration</span>=<span class="string">&quot;0:0:0.2&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;/<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;/<span class="name">VisualTransition</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">VisualTransition</span> <span class="attr">GeneratedDuration</span>=<span class="string">&quot;0:0:0.7&quot;</span> <span class="attr">To</span>=<span class="string">&quot;Normal&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                            <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;FlipButtonTransform&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;Angle&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">To</span>=<span class="string">&quot;-90&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Duration</span>=<span class="string">&quot;0:0:0.2&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;/<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;/<span class="name">VisualTransition</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;/<span class="name">VisualStateGroup.Transitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">VisualState</span> <span class="attr">x:Name</span>=<span class="string">&quot;Normal&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;BackContent&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;Opacity&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">To</span>=<span class="string">&quot;0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Duration</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;/<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;/<span class="name">VisualState</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">VisualState</span> <span class="attr">x:Name</span>=<span class="string">&quot;Flipped&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;FlipButtonTransform&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;Angle&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">To</span>=<span class="string">&quot;90&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Duration</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;FrontContent&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;Opacity&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">To</span>=<span class="string">&quot;0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Duration</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;/<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;/<span class="name">VisualState</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">VisualStateGroup</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">VisualStateManager.VisualStateGroups</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ControlTemplate</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Setter.Value</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Setter</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">Style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ResourceDictionary</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>实例中的实现注意细节</p>
</blockquote>
<h4 id="翻转动画"><a href="#翻转动画" class="headerlink" title="翻转动画"></a>翻转动画</h4><p>&emsp;&emsp;使用旋转动画前，需要先声明<code>RotateTransform</code>；这里的<code>RotateTransform</code>是通过<em>x:Name</em>直接命名的，如果不采用命名需要使用原始的写法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;FlipButton&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;(UIElement.RenderTransform).(RotateTransform.Angle)&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">To</span>=<span class="string">&quot;90&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Duration</span>=<span class="string">&quot;0:0:0.2&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="定义状态动画"><a href="#定义状态动画" class="headerlink" title="定义状态动画"></a>定义状态动画</h4><p>&emsp;&emsp;状态动画是控件模板中最有趣的部分。它们是提供翻转行为的要素，它们还是为<em>FlipPanel</em>创建自定义模板的开发人员最有可能修改的细节。为定义状态组，必须在控件模板的跟元素中添加<code>VisualStateManager.VisualStateGroups</code>元素，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">ControlTemplate</span> <span class="attr">TargetType</span>=<span class="string">&quot;&#123;x:Type local:FlipPanel&#125;&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- VisualStateManager只能附加到FrameworkElement元素中，所以需要放在Grid中，不能直接放在ControlTemplate根下 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">VisualStateManager.VisualStateGroups</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 使用具有合适名称的VisualStateGroup，同一组的状态放在一起 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">VisualStateGroup</span> <span class="attr">x:Name</span>=<span class="string">&quot;GroupName1&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">VisualState</span> <span class="attr">x:Name</span>=<span class="string">&quot;StateName1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">VisualState</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">VisualState</span> <span class="attr">x:Name</span>=<span class="string">&quot;StateName2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">VisualState</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">VisualStateGroup</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">VisualStateManager.VisualStateGroups</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ControlTemplate</span>&gt;</span></span><br></pre></td></tr></table></figure>

<div class="note info flat"><p>&emsp;&emsp;为给模板添加 VisualStateManager 元素，模板必须使用布局面板。布局面板包含控件的两个可视化对象和 VisualStateManager 元素(该元素不可见)。VisualStateManager 定义具有动画的故事板，控件在合适的时机使用动画改变其外观。</p>
</div>

<p>&emsp;&emsp;每隔状态对应一个具有一个或多个动画的故事板。如果存在这些故事板，就会在适当的时机触发它们(如果不存在，控件将按正常方式降级，而不会引发错误)</p>
<blockquote>
<p>这里将可视化状态持续时间设置为0，这意味着动画立即应用其效果。这看起来可能有些怪——毕竟，不是需要更平缓的改变从而能够注意到动画效果吗？</p>
</blockquote>
<p>&emsp;&emsp;<strong>实际上，该设计完全正确，因为可视化状态用于表示控件在适当状态时的外观。</strong>；<em>例如，当翻转面板处于翻转过的状态时，简单地显示其背面内容。翻转过程是在 FlipPanel 控件进入翻转状态前的过渡，而不是翻转状态本身的一部分(状态和过渡之间的这个区别是很重要的，因为有些控件确实具有在状态期间运行的动画。)</em></p>
<h4 id="定义状态过渡"><a href="#定义状态过渡" class="headerlink" title="定义状态过渡"></a>定义状态过渡</h4><p>&emsp;&emsp;过渡是成当前状态到新状态的动画。变换模型的优点之一是不需要为动画创建故事板。例如，如果添加如下标记，WPF会创建持续时间为0.7秒的动画以改变<em>FlipPanel</em>控件的透明度，从而创建希望的悦目的褪色效果：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">VisualStateGroup</span> <span class="attr">x:Name</span>=<span class="string">&quot;ViewStates&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">VisualStateGroup.Transitions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">VisualTransition</span> <span class="attr">GeneratedDuration</span>=<span class="string">&quot;0:0:0.7&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">VisualTransition</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">VisualStateGroup.Transitions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">VisualState</span> <span class="attr">x:Name</span>=<span class="string">&quot;Normal&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">VisualState</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">VisualState</span> <span class="attr">x:Name</span>=<span class="string">&quot;Flipped&quot;</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">VisualState</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">VisualStateManager.VisualStateGroups</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;过渡会应用到状态组。当定义过渡时，必须将其添加到<code>VisualStateGroup.Transitions</code>集合。上面的示例使用最简单的过渡类型：默认过渡。默认过渡应用于该组中的所有状态变化.</p>
<p>&emsp;&emsp;默认过渡是很方便的，但用于所有情况的解决方案不可能总是适合的。例如，您可能希望FlipPanel控件根据其进入的状态以不同的速度过渡。为实现该效果，需要定义多个过渡，并且需要设置 To 属性以指示何时应用过渡效果。例如，如果有以下过渡：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">VisualStateGroup.Transitions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">VisualTransition</span> <span class="attr">To</span>=<span class="string">&quot;Flipped&quot;</span> <span class="attr">GeneratedDuration</span>=<span class="string">&quot;0:0:0.5&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">VisualTransition</span> <span class="attr">To</span>=<span class="string">&quot;Normal&quot;</span> <span class="attr">GeneratedDuration</span>=<span class="string">&quot;0:0:0.1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">VisualStateGroup.Transitions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;这个示例显示了当进入特定状态时应用的过渡，但<strong>还可使用From 属性创建当离开某个状态时应用的过渡,并且可结合使用 To 和 From 属性来创建更特殊的只有当在特定的两个状态之间移动时才会应用的过渡。当应用过渡时 WPF遍历过渡集合，在所有应用的过渡中查找最特殊的过渡，并只使用最特殊的那个过渡。</strong></p>
<p>&emsp;&emsp;为了进一步加以控制，可创建自定义过渡动画来替换 WPF 通常使用的自动生成的过渡。您可能会由于几个原因而创建自定义过渡。下面是一些例子:使用更复杂的动画控制动画的步长，使用动画缓动、连续运行几个动画或在运行动画时播放声音</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">VisualStateGroup.Transitions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">VisualTransition</span> <span class="attr">GeneratedDuration</span>=<span class="string">&quot;0:0:0.7&quot;</span> <span class="attr">To</span>=<span class="string">&quot;Flipped&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Storyboard</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span><br><span class="line"><span class="tag">                <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;FlipButtonTransform&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;Angle&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">To</span>=<span class="string">&quot;90&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">Duration</span>=<span class="string">&quot;0:0:0.2&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Storyboard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">VisualTransition</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">VisualTransition</span> <span class="attr">GeneratedDuration</span>=<span class="string">&quot;0:0:0.7&quot;</span> <span class="attr">To</span>=<span class="string">&quot;Normal&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Storyboard</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span><br><span class="line"><span class="tag">                <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;FlipButtonTransform&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;Angle&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">To</span>=<span class="string">&quot;-90&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">Duration</span>=<span class="string">&quot;0:0:0.2&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Storyboard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">VisualTransition</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">VisualStateGroup.Transitions</span>&gt;</span></span><br></pre></td></tr></table></figure>

<div class="note warning flat"><p>&emsp;&emsp;当使用自定义过渡时，仍必须设置 VisualTransition.GeneratedDuration 属性以匹配动画的持续时间。如果没有设置该细节，VisualStateManager 就不能使用自定义过渡，而且它将立即应用新状态(使用的实际时间值对于您的自定义过渡仍无效果，因为它只应用于自动生成的动画)。</p>
</div>

<p>&emsp;&emsp;但许多控件需要自定义过渡，而且编写自定义过渡是非常乏味的工作。仍需保持零长度的状态动画，这还会不可避免地在可视化状态和过渡之间复制一些细节。</p>
<h4 id="关联元素"><a href="#关联元素" class="headerlink" title="关联元素"></a>关联元素</h4><p>&emsp;&emsp;现在，已经得到了一个相当好的控件模板，需要在 <em>FlipPanel</em> 控件中添加一些内容以使该模板工作。</p>
<p>&emsp;&emsp;诀窍是使用<code>OnApplyTemplate()</code>方法，该方法还用于在<code>ColorPicker</code>控件中设置绑定。对于<code>FlipPanel</code>控件，<code>OnApplyTemplate()</code>方法用于为<code>FlipButton</code>和<code>FlipButtonAlternate</code>部件检索<code>ToggleButton</code>，并为每个部件关联事件处理程序，从而当用户单击以翻转控件时能够进行响应。最后，<code>OnApplyTemplate()</code>方法调用名为<code>ChangeVisualState()</code>的自定义方法，该方法确保控件的可视化外观和当前状态匹配：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnApplyTemplate</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">base</span>.OnApplyTemplate();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Wire up the ToggleButton.Click event.</span></span><br><span class="line">    ToggleButton? flipButton = GetTemplateChild(<span class="string">&quot;FlipButton&quot;</span>) <span class="keyword">as</span> ToggleButton;</span><br><span class="line">    <span class="keyword">if</span> (flipButton != <span class="literal">null</span>) flipButton.Click += FlipButton_Click;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allow for two flip buttons if needed (one for each side of the panel).</span></span><br><span class="line">    ToggleButton? flipButtonAlternate = GetTemplateChild(<span class="string">&quot;FlipButtonAlternate&quot;</span>) <span class="keyword">as</span> ToggleButton;</span><br><span class="line">    <span class="keyword">if</span> (flipButtonAlternate != <span class="literal">null</span>) flipButtonAlternate.Click += FlipButton_Click;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure the visuals match the current state.</span></span><br><span class="line">    <span class="keyword">this</span>.ChangeVisualState(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">FlipButton_Click</span>(<span class="params"><span class="built_in">object</span> sender, RoutedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>.IsFlipped = !<span class="keyword">this</span>.IsFlipped;</span><br><span class="line">    ChangeVisualState(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ChangeVisualState</span>(<span class="params"><span class="built_in">bool</span> useTransitions</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!IsFlipped)</span><br><span class="line">    &#123;</span><br><span class="line">        VisualStateManager.GoToState(<span class="keyword">this</span>, <span class="string">&quot;Normal&quot;</span>, useTransitions);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        VisualStateManager.GoToState(<span class="keyword">this</span>, <span class="string">&quot;Flipped&quot;</span>, useTransitions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note danger flat"><p>&emsp;&emsp;当调用 GetTemplateChild()方法时，需要给出希望获取的元素的字符串名称。为避免可能的错误，可在控件中将该字符串声明为常量。然后在TemplatePart 特性中以及调用GetTemplateChild()方法时可以使用该常量。</p>
</div>


<p>&emsp;&emsp;幸运的是，不需要手动触发状态动画。既不需要创建也不需要触发过渡动画。相反，<strong>为从一个状态改变到另一个状态，只需要调用静态方法 VisualStateManager.GoToState()。</strong>当调用该方法时，传递正在改变状态的控件对象的引用、新状态的名称以及确定<strong>是否显示过渡的 Boolean值。</strong> <strong>如果是由用户引发的改变(例如，当用户单击 ToggleButon 按钮时)，该值应当为true;如果是由属性设置引发的改变(例如，如果使用页面的标记设置IsFlipped 属性的初始值)，该值为 false。</strong></p>
<p>&emsp;&emsp;<em>处理控件支持的所有不同状态可能会变得很凌乱。为避免在整个控件代码中分散调用GoToState( )方法，大多数控件添加了与在 FlipPanel 控件中添加的 ChangeVisualState()类似的方法。该方法负责应用每个状态组中的正确状态。该方法中的代码使用if语句块(或 switch 语句)应用每个状态组的当前状态。该方法之所以可行，是因为它完全可以使用当前状态的名称调用GoToState()方法。在这种情况下，<code>如果当前状态和请求的状态相同，那么什么也不会发生。</code></em></p>
<blockquote>
<p>通常在以下为止调用<code>ChangeVisualState()</code>方法或与其等效的方法：</p>
</blockquote>
<ul>
<li>在<code>OnApplyTemplate()</code>方法的结尾，在初始化控件之后</li>
<li>当响应代表状态改变的事件时，例如鼠标移动或单击<em>ToggleButton</em>按钮</li>
<li>当响应属性改变或通过代码触发时（例如，<code>IsFlipped</code>属性设置器调用<code>ChangeVisualState()</code>方法并且总是提供true，所以显示过渡动画。如果希望为控件使用者提供不显示过渡的机会，可添加<code>Flip()</code>方法，该方法接受与为<code>ChangeVisualState()</code>方法传递相同的Boolean参数）。</li>
</ul>
<p>&emsp;&emsp;正如上面介绍的，FlipPanel控件非常灵活。例如，可使用该控件并且不使用ToggleButon 按钮，通过代码进行翻转(可能是当用户单击不同的控件时)。也可在控件模板中包含一两个翻转按钮并且允许用户进行控制。</p>
<h3 id="使用FlipPanel控件"><a href="#使用FlipPanel控件" class="headerlink" title="使用FlipPanel控件"></a>使用FlipPanel控件</h3><p>&emsp;&emsp;现在已经完成了 FlipPanel 控件的控件模板和代码，已经准备好在应用程序中使用该控件假定已添加了必需的程序集引用，然后可将XML前缀映射到包含自定义控件的名称空间:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Window</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Class</span>=<span class="string">&quot;WpfApp.MainWindow&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:d</span>=<span class="string">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:lib</span>=<span class="string">&quot;clr-namespace:CustomControlLibrary;assembly=CustomControlLibrary&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:local</span>=<span class="string">&quot;clr-namespace:WpfApp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:r</span>=<span class="string">&quot;clr-namespace:ResourceLibrary;assembly=ResourceLibrary&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Title</span>=<span class="string">&quot;MainWindow&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Width</span>=<span class="string">&quot;375&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Height</span>=<span class="string">&quot;260&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lib:FlipPanel</span></span></span><br><span class="line"><span class="tag">            <span class="attr">x:Name</span>=<span class="string">&quot;panel&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Margin</span>=<span class="string">&quot;10&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">BorderBrush</span>=<span class="string">&quot;DarkOrange&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">BorderThickness</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">CornerRadius</span>=<span class="string">&quot;4&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lib:FlipPanel.FrontContent</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">StackPanel</span> <span class="attr">Margin</span>=<span class="string">&quot;6&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">TextBlock</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Margin</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">FontSize</span>=<span class="string">&quot;16&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Foreground</span>=<span class="string">&quot;DarkOrange&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">TextWrapping</span>=<span class="string">&quot;Wrap&quot;</span>&gt;</span></span><br><span class="line">                        This is the front side of the FlipPanel.</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">TextBlock</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Margin</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Padding</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Content</span>=<span class="string">&quot;Button One&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Margin</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Padding</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Content</span>=<span class="string">&quot;Button Two&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Margin</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Padding</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Content</span>=<span class="string">&quot;Button Three&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Margin</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Padding</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Content</span>=<span class="string">&quot;Button Four&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">StackPanel</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lib:FlipPanel.FrontContent</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lib:FlipPanel.BackContent</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Grid</span> <span class="attr">Margin</span>=<span class="string">&quot;6&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Grid.RowDefinitions</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;*&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">Grid.RowDefinitions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">TextBlock</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Margin</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">FontSize</span>=<span class="string">&quot;16&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Foreground</span>=<span class="string">&quot;DarkMagenta&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">TextWrapping</span>=<span class="string">&quot;Wrap&quot;</span>&gt;</span></span><br><span class="line">                        This is the back side of the FlipPanel.</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">TextBlock</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Grid.Row</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Margin</span>=<span class="string">&quot;3&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Padding</span>=<span class="string">&quot;10&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">HorizontalAlignment</span>=<span class="string">&quot;Center&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">VerticalAlignment</span>=<span class="string">&quot;Center&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Click</span>=<span class="string">&quot;cmdFlip_Click&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">Content</span>=<span class="string">&quot;Flip Back to Front&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lib:FlipPanel.BackContent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lib:FlipPanel</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Window</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;当单击<code>FlipPanel</code>背面的按钮时，通过编程翻转面板：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cmdFlip_Click</span>(<span class="params"><span class="built_in">object</span> sender, RoutedEventArgs e</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    panel.IsFlipped = !panel.IsFlipped;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用不同的控件模板"><a href="#使用不同的控件模板" class="headerlink" title="使用不同的控件模板"></a>使用不同的控件模板</h3><p>&emsp;&emsp;已经恰当设计好的自定义控件极其灵活。对于FlipPanel控件，可提供新模板来更改ToggleButton 按钮的外观和位置，并修改当在前后内容区域之间进行切换时应用的动画效果。</p>
<p>&emsp;&emsp;<em>在此，翻转按钮被放置到一个特殊的栏中，该栏位于前面的底部并且位于后面的顶部。当翻转面板时，它不是像一页纸那样翻转内容。相反，它缩小前面内容的同时在后面展开后面的内容。当反向翻转面板时，后面的内容从下面开始挤向后面，前面的内容从上面展开。为实现更精彩的效果，甚至还借助于BlurEfect 类模糊正在变形的内容。</em></p>
<img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/7stMFZb0Xf.gif"/>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ResourceDictionary</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:local</span>=<span class="string">&quot;clr-namespace:CustomControlLibrary&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Style</span> <span class="attr">TargetType</span>=<span class="string">&quot;&#123;x:Type local:FlipPanel&#125;&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Setter</span> <span class="attr">Property</span>=<span class="string">&quot;Template&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Setter.Value</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ControlTemplate</span> <span class="attr">TargetType</span>=<span class="string">&quot;&#123;x:Type local:FlipPanel&#125;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Grid.RowDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">Grid.RowDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                        <span class="comment">&lt;!--  This is the front content.  --&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Border</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">x:Name</span>=<span class="string">&quot;FrontContent&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Background</span>=<span class="string">&quot;&#123;TemplateBinding Background&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">BorderBrush</span>=<span class="string">&quot;&#123;TemplateBinding BorderBrush&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">BorderThickness</span>=<span class="string">&quot;&#123;TemplateBinding BorderThickness&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">CornerRadius</span>=<span class="string">&quot;&#123;TemplateBinding CornerRadius&#125;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Border.RenderTransform</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">ScaleTransform</span> <span class="attr">x:Name</span>=<span class="string">&quot;FrontContentTransform&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Border.RenderTransform</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Border.Effect</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">BlurEffect</span> <span class="attr">x:Name</span>=<span class="string">&quot;FrontContentEffect&quot;</span> <span class="attr">Radius</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Border.Effect</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Grid.RowDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;*&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;/<span class="name">Grid.RowDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">ContentPresenter</span> <span class="attr">Content</span>=<span class="string">&quot;&#123;TemplateBinding FrontContent&#125;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Rectangle</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Grid.Row</span>=<span class="string">&quot;1&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Fill</span>=<span class="string">&quot;LightSteelBlue&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Stretch</span>=<span class="string">&quot;Fill&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">ToggleButton</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">x:Name</span>=<span class="string">&quot;FlipButton&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Grid.Row</span>=<span class="string">&quot;1&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Margin</span>=<span class="string">&quot;5&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Padding</span>=<span class="string">&quot;15,0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">HorizontalAlignment</span>=<span class="string">&quot;Right&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Content</span>=<span class="string">&quot;^&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">FontSize</span>=<span class="string">&quot;12&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">FontWeight</span>=<span class="string">&quot;Bold&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">Border</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                        <span class="comment">&lt;!--  This is the back content.  --&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Border</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">x:Name</span>=<span class="string">&quot;BackContent&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">Background</span>=<span class="string">&quot;&#123;TemplateBinding Background&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">BorderBrush</span>=<span class="string">&quot;&#123;TemplateBinding BorderBrush&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">BorderThickness</span>=<span class="string">&quot;&#123;TemplateBinding BorderThickness&#125;&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                            <span class="attr">CornerRadius</span>=<span class="string">&quot;&#123;TemplateBinding CornerRadius&#125;&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Border.RenderTransform</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">ScaleTransform</span> <span class="attr">x:Name</span>=<span class="string">&quot;BackContentTransform&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Border.RenderTransform</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Border.Effect</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">BlurEffect</span> <span class="attr">x:Name</span>=<span class="string">&quot;BackContentEffect&quot;</span> <span class="attr">Radius</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Border.Effect</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Grid.RowDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;*&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">RowDefinition</span> <span class="attr">Height</span>=<span class="string">&quot;auto&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;/<span class="name">Grid.RowDefinitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">ContentPresenter</span> <span class="attr">Content</span>=<span class="string">&quot;&#123;TemplateBinding BackContent&#125;&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Rectangle</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Grid.Row</span>=<span class="string">&quot;1&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Fill</span>=<span class="string">&quot;LightSteelBlue&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Stretch</span>=<span class="string">&quot;Fill&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">ToggleButton</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">x:Name</span>=<span class="string">&quot;FlipButtonAlternate&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Grid.Row</span>=<span class="string">&quot;1&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Margin</span>=<span class="string">&quot;5&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Padding</span>=<span class="string">&quot;15,0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">HorizontalAlignment</span>=<span class="string">&quot;Right&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">Content</span>=<span class="string">&quot;^&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">FontSize</span>=<span class="string">&quot;12&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                    <span class="attr">FontWeight</span>=<span class="string">&quot;Bold&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">Border</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">VisualStateManager.VisualStateGroups</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">VisualStateGroup</span> <span class="attr">x:Name</span>=<span class="string">&quot;ViewStates&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">VisualStateGroup.Transitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">VisualTransition</span> <span class="attr">GeneratedDuration</span>=<span class="string">&quot;0:0:0.7&quot;</span> <span class="attr">To</span>=<span class="string">&quot;Flipped&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                            <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;FlipButton&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;(UIElement.RenderTransform).(RotateTransform.Angle)&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">To</span>=<span class="string">&quot;90&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Duration</span>=<span class="string">&quot;0:0:0.2&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;/<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;/<span class="name">VisualTransition</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">VisualTransition</span> <span class="attr">GeneratedDuration</span>=<span class="string">&quot;0:0:0.7&quot;</span> <span class="attr">To</span>=<span class="string">&quot;Normal&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                            <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;FlipButton&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;(UIElement.RenderTransform).(RotateTransform.Angle)&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">To</span>=<span class="string">&quot;-90&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                                <span class="attr">Duration</span>=<span class="string">&quot;0:0:0.2&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;/<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;/<span class="name">VisualTransition</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;/<span class="name">VisualStateGroup.Transitions</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">VisualState</span> <span class="attr">x:Name</span>=<span class="string">&quot;Normal&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;BackContent&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;Opacity&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">To</span>=<span class="string">&quot;0&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Duration</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;/<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;/<span class="name">VisualState</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">VisualState</span> <span class="attr">x:Name</span>=<span class="string">&quot;Flipped&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;FrontContentTransform&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;ScaleY&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">To</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;FrontContentEffect&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;Radius&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">To</span>=<span class="string">&quot;30&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;BackContentTransform&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;ScaleY&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">To</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                        <span class="tag">&lt;<span class="name">DoubleAnimation</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetName</span>=<span class="string">&quot;BackContentEffect&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">Storyboard.TargetProperty</span>=<span class="string">&quot;Radius&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                                            <span class="attr">To</span>=<span class="string">&quot;0&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                                    <span class="tag">&lt;/<span class="name">Storyboard</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;/<span class="name">VisualState</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">VisualStateGroup</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">VisualStateManager.VisualStateGroups</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ControlTemplate</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Setter.Value</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Setter</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">Style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ResourceDictionary</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="创建自定义面板"><a href="#创建自定义面板" class="headerlink" title="创建自定义面板"></a>创建自定义面板</h2><p>&emsp;&emsp;创建自定义面板是一种特殊但较常见的自定义控件开发子集。面板驻留一个或多个子元素，并且实现了特定的布局逻辑以恰当地安排其子元素。如果希望构建自己的可拖动的工具栏或可停靠的窗口系统，自定义面板是很重要的元素。当创建需要非标准特定布局的组合控件时，自定义面板通常是很有用的，例如花哨的停工具栏。</p>
<p>&emsp;&emsp;<em>现在，对于 WPF 提供的用于组织内容的基本类型的面板(如 StackPanel、DockPanel、WrapPanel、Canvas 以及 Grid)已经很熟悉了，也已经看到了一些使用它们自己自定义面板的 WPF 元素(如TabPanel、ToolBarOverflowPanel 以及 VirtualizingPanel)。可以在线査找更多有关自定义面板的示例。下面是一些值得研究的示例:</em></p>
<ul>
<li>允许拖动其子元素而不需要额外事件处理代码的自定义Canvas面板</li>
<li>针对项列表实现了鱼眼效果和螺旋效果的两个面板</li>
<li>使用基于帧的动画成一种布局变换到其他布局的面板</li>
</ul>
<blockquote>
<p>接下来的几节讲将介绍创建自定义面板，并且还将分析两个简单的示例——一个基本的Canvas面板副本，以及一个增强版本的WrapPanel面板</p>
</blockquote>
<h2 id="两步布局过程"><a href="#两步布局过程" class="headerlink" title="两步布局过程"></a>两步布局过程</h2><p>&emsp;&emsp;<strong>每个面板都使用相同的设备:负责改变子元素尺寸和安排子元素的两步布局过程。第一个阶段是测量阶段(measure pass)，在这一阶段面板决定其子元素希望具有多大的尺寸。第二个阶段是排列阶段(layoutpass)，在这一阶段为每个控件指定边界。</strong>这两个步骤是必需的，因为在决定如何分割可用空间时，面板需要考虑所有子元素的期望。</p>
<p>&emsp;&emsp;可以通过重写<code> MeasureOveride()</code>和 <code>ArangeOveride()</code>方法，为这两个步骤添加自己的逻辑，这两个方法是作为 WPF布局系统的一部分在FrameworkElement类中定义的。</p>
<h3 id="MeasureOverride-方法"><a href="#MeasureOverride-方法" class="headerlink" title="MeasureOverride()方法"></a>MeasureOverride()方法</h3><p>&emsp;&emsp;第一步是首先使用 MeasureOverride()方法决定每个子元素希望多大的空间。然而，<strong>即使是在 MeasureOverride()方法中，也不能为子元素提供无限空间。至少，也应当将子元素限制在能够适应面板可用空间的范围之内。此外，可能希望更严格地限制子元素。</strong>例如，具有按比例分配尺寸的两行的 Grid 面板，会为子元素提供可用高度的一半。StackPanel 面板会为第一个元素提供所有可用空间，然后为第二个元素提供剩余的空间，等等。</p>
<p>&emsp;&emsp;每个 MeasureOverride()方法的实现负贵遍历子元素集合，并调用每个子元素的 Measure()方法。当调用 Measure()方法时，需要提供边界框—— 决定每个子控件最大可用空间的 Size 对象。在 MeasureOverride()方法的最后，面板返回显示所有子元素所需的空间，并返回它们所期望的尺寸。</p>
<p>&emsp;&emsp;下面是MeasureOverride()方法的基本结构，其中没有具体的尺寸细节：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Size <span class="title">MeasureOverride</span>(<span class="params">Size constraint</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Examine all the children.</span></span><br><span class="line">    <span class="keyword">foreach</span>(UIElement element <span class="keyword">in</span> <span class="keyword">base</span>.InternalChildren)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Ask each child how much space it would like, given the availableSize constraint.</span></span><br><span class="line">        Size availableSize = <span class="keyword">new</span> Size(...);</span><br><span class="line">        element.Measure(availableSize);</span><br><span class="line">        <span class="comment">// (You can now read element.DesiredSize to get the requested size.)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Indicate how much space this panel requires.</span></span><br><span class="line">    <span class="comment">// This will be used to set the DesiredSize property of the panel.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Size(...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;<em>Measure()方法不返回数值。在为每个子元素调用 Measure()方法之后，子元素的 DesiredSize属性提供了请求的尺寸。可以在为后续子元素执行计算时(以及决定面板需要的总空间时)使用这一信息。</em></p>
<p>&emsp;&emsp;<em>因为许多元素直到调用了 Measured()方法之后才会渲染它们自身，所以必须为每个子元素调用 Measure()方法，即使不希望限制子元素的尺寸或使用 DesiredSize 属性也同样如此。如果希望让所有子元素能够自由获得它们所希望的全部空间，可以传递在两个方向上的值都是Double.PositiveInfinity 的 Size 对象(ScrollViewer 是使用这种策略的一个元素，原因是它可以处理任意数量的内容)。然后子元素会返回其中所有内容所需要的空间。否则，子元素通常会返回其中内容需要的空间或可用空间——返回较小者。</em></p>
<p>&emsp;&emsp;在测量过程的结尾，布局容器必须返回它所期望的尺寸。在简单的面板中，可以通过组合每个子元素的期望尺寸计算面板所期望的尺寸。</p>
<div class="note warning flat"><p>&emsp;&emsp;不能为面板的期望尺寸简单地返回传递给 MeasureOverride()方法的限制范围。尽管这看起来是获取所有可用空间的好方法，但如果容器传递 Size 对象，而且 Size 对象的一个方向或两个方向上的数值是 Double.PositiveInfinity(这意味着“占用需要的所有控件空间”)，这时就会出现麻烦。尽管对于尺寸限制范围来说，无限的尺寸是允许的，但是对于尺寸结果，无限的尺寸是不允许的，因为 WPF 不能计算出元素应当多大。另外，实际上不应当使用超出需要的更大空间。如果这样做的话，可能会导致额外的空白空间,并且布局面板之后的元素会在窗口中进一步下移</p>
</div>

<p>&emsp;&emsp;为每个子元素调用的 Measure()方法和定义面板布局逻辑第步的 MeasureOverride()方法极其相似。实际上，Measure()方法会触发 MeasureOverride()方法。所以，如果在一个布局容器中放置另一个布局容器，当调用 Measure()方法时，将会得到布局容器及其所有子元素所需的总尺寸。</p>
<div class="note info flat"><p>&emsp;&emsp;通过两步执行测量过程(触发 MeasureOverride()方法的 Measure()方法)的一个原因是为了处理外边距。当调用 Measure()方法时，传递总的可用空间。当WPF 调用 MeasureOverride()方法时，考虑到外边距空间，会自动减少可用空间(除非传递无限的尺寸)。</p>
</div>

<h3 id="ArrangeOverride-方法"><a href="#ArrangeOverride-方法" class="headerlink" title="ArrangeOverride()方法"></a>ArrangeOverride()方法</h3><p>&emsp;&emsp;测量完所有元素后，就可以在可用的空间中排列元素了。布局系统调用面板的<code>ArrangeOverride()</code>方法，而面板为每个子元素调用<code>Arrange()</code>方法，以告诉子元素为它分配了多大的空间（<strong>Arange()方法会触发 ArrangeOvemide()方法，这与 Measure()方法会触发 MeasureOverride()方法非常类似</strong>）。</p>
<p>&emsp;&emsp;当使用Measure()方法测量条目时，传递能够定义可用空间边界的Size对象。当使用Arrange()方法放置条目时，传递能够定义条目尺寸和位置的 System.Windows.Rect对象。这时，就像使用 Canvas 面板风格的X和Y坐标放置每个元素一样(坐标确定布局容器左上角与元素左上角之间的距离)。</p>
<blockquote>
<p>下面是<code>ArrangeOveride()</code>方法的基本结构，其中没有给出具体的尺寸细节：</p>
</blockquote>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Size <span class="title">ArrangeOveride</span>(<span class="params">Size arrangeSize</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Examine all the children.</span></span><br><span class="line">    <span class="keyword">foreach</span>(UIElement element <span class="keyword">in</span> <span class="keyword">base</span>.InternalChildren)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Assign the child it&#x27;s bounds.</span></span><br><span class="line">        Rect bounds = <span class="keyword">new</span> Rect(...);</span><br><span class="line">        element.Arrange(bounds);</span><br><span class="line">        <span class="comment">// (You can now element.ActualHeight and element.ActualWidth to find out the size it used...)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Indicate how much space this panel occupies.</span></span><br><span class="line">    <span class="comment">// This will be used to set the ActualHeight and ActualWidth properties of the panel</span></span><br><span class="line">    <span class="keyword">return</span> arrangeSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;当排列元素时，不能传递无限尺寸。然而，可以通过传递来自DesiredSize属性的值，为元素提供它所期望的数值。也可以为元素提供比所需尺寸更大的空间。实际上，经常会出现这种情况。例如，垂直的 StackPanel 面板为其子元素提供所请求的高度，但是为子元素提供面板本身的整个宽度。同样，Grid 面板使用具有固定尺寸或按比例计算尺寸的行，这些行的尺寸可能大于其内部元素所期望的尺寸。即使已经在根据内容改变尺寸的容器中放置了元素，如果使用Height 和 Width 属性明确设置了元素的尺寸，那么仍可以扩展该元素。</p>
<p>&emsp;&emsp;当使元素比所期望的尺寸更大时，就需要使用HorizontalAlignment和 VerticalAlignment 属元素内容被放在指定边界内部的某个位置</p>
<p>&emsp;&emsp;因为 ArrangeOverride()方法总是接收定义的尺寸(而非无限的尺寸)，所以为了设置面板的最终尺寸，可以返回传递的 Size对象。实际上，许多布局容器就是采用这一步骤来占据提供的所有空间(不能冒险占用其他控件可能需要的空间，因为除非有可用空间，否则布局系统的测量步骤一定不会为元素提供超出需要的空间)。</p>
<h3 id="Canvas面板的副本"><a href="#Canvas面板的副本" class="headerlink" title="Canvas面板的副本"></a>Canvas面板的副本</h3><p>&emsp;&emsp;理解这两个方法的最快捷方式是研究<code>Canvas</code>类的内部工作原理，<code>Canvas</code>是最简单的布局容器。为了创建自己的<code>Canvas</code>风格的面板，只需要简单地继承<code>Panel</code>类，并且添加<code>MeasureOverride()</code>和<code>ArrangeOverride()</code>方法，如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CanvasClone</span> : <span class="title">System.Windows.Controls.Panel</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;<strong>Canvas面板在它们希望的为止放置子元素，并且为子元素设置它们希望的尺寸。所以，Canvas面板不需要计算如何分割可用空间。</strong> 这使得<code>MeasureOverride()</code>方法非常简单。为每个子元素提供无限的空间：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Size <span class="title">MeasureOverride</span>(<span class="params">Size availableSize</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// PositiveInfinity：正无穷大</span></span><br><span class="line">    Size size = <span class="keyword">new</span> Size(<span class="built_in">double</span>.PositiveInfinity, <span class="built_in">double</span>.PositiveInfinity);</span><br><span class="line">    <span class="keyword">foreach</span> (UIElement element <span class="keyword">in</span> <span class="keyword">base</span>.InternalChildren)</span><br><span class="line">    &#123;</span><br><span class="line">        element.Measure(size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Size();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;注意，<strong>MeasureOverride()方法返回空的Size对象。这意味着Canvas面板根本不请求任何空间，而是由您明确地为Canvas面板指定尺寸，或者将其放置到布局容器中进行拉伸以填充整个容器的可用空间。</strong></p>
<p>&emsp;&emsp;<code>ArrangeOverride()</code>方法包含的内容稍微多一些。为了确定每个元素的正确为止，<code>Canvas</code>面板使用附加属性（<em>Left、Right、Top以及Bottom</em>），附加属性是使用定义类中的来了哥哥辅助方法实现的：<code>GetProperty()和SetProperty()</code>。</p>
<blockquote>
<p>在此分析的Canvas面板副本简单一些——<em>只使用Left和Top附加属性</em>。下面是用于排列元素的代码：</p>
</blockquote>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Size <span class="title">ArrangeOverride</span>(<span class="params">Size finalSize</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (UIElement element <span class="keyword">in</span> <span class="keyword">base</span>.InternalChildren)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">double</span> x = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">double</span> y = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">double</span> left = Canvas.GetLeft(element);</span><br><span class="line">        <span class="keyword">if</span> (!Double.IsNaN(left))</span><br><span class="line">        &#123;</span><br><span class="line">            x = left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">double</span> top = Canvas.GetTop(element);</span><br><span class="line">        <span class="keyword">if</span> (!Double.IsNaN(top))</span><br><span class="line">        &#123;</span><br><span class="line">            y = top;</span><br><span class="line">        &#125;</span><br><span class="line">        element.Arrange(<span class="keyword">new</span> Rect(<span class="keyword">new</span> Point(x, y), element.DesiredSize));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> finalSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="更好的WrapPanel面板"><a href="#更好的WrapPanel面板" class="headerlink" title="更好的WrapPanel面板"></a>更好的WrapPanel面板</h3><p>&emsp;&emsp;WrapPanel面本执行一个简单的功能，该功能有时十分有用。该面板逐个地布置其子元素，一旦当前行的宽度用完，就会切换到下一行。但有时您需要<strong>采用一种方法来强制立即换行，以便在新行中启动某个特定控件。</strong>尽管WrapPanel面板原本没有提供这一功能，但通过创建自定义控件可方便地添加该功能。只需要添加一个请求换行的附加属性即可。此后，面板中的子元素可使用该属性在适当位置换行。</p>
<p>&emsp;&emsp;下面的代码清单显示了<code>WrapBreakPanel</code>类，该类添加了<code>LineBreakBeforeProperty</code>附加属性。当将该属性设置为true时，这个属性会导致在元素之前立即换行。</p>
<img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240730213831.png"/>

<div class="tabs" id="wrapbreakpanel"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="wrapbreakpanel-1">WrapBreakPanel</button><button type="button" class="tab " data-href="wrapbreakpanel-2">Use WrapBreakPanel</button></ul><div class="tab-contents"><div class="tab-item-content active" id="wrapbreakpanel-1"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WrapBreakPanel</span> : <span class="title">System.Windows.Controls.Panel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">GetLineBreakBefore</span>(<span class="params">DependencyObject obj</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">bool</span>)obj.GetValue(LineBreakBeforeProperty);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetLineBreakBefore</span>(<span class="params">DependencyObject obj, <span class="built_in">bool</span> <span class="keyword">value</span></span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        obj.SetValue(LineBreakBeforeProperty, <span class="keyword">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty LineBreakBeforeProperty =</span><br><span class="line">        DependencyProperty.RegisterAttached(</span><br><span class="line">            <span class="string">&quot;LineBreakBefore&quot;</span>,</span><br><span class="line">            <span class="keyword">typeof</span>(<span class="built_in">bool</span>),</span><br><span class="line">            <span class="keyword">typeof</span>(WrapBreakPanel),</span><br><span class="line">            <span class="keyword">new</span> FrameworkPropertyMetadata(<span class="literal">false</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 指明该属性影响布局过程</span></span><br><span class="line">                AffectsArrange = <span class="literal">true</span>,</span><br><span class="line">                AffectsMeasure = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 测量阶段</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;availableSize&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Size <span class="title">MeasureOverride</span>(<span class="params">Size availableSize</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Size currentLineSize = <span class="keyword">new</span> Size();</span><br><span class="line">        Size panelSize = <span class="keyword">new</span> Size();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (UIElement element <span class="keyword">in</span> <span class="keyword">base</span>.InternalChildren)</span><br><span class="line">        &#123;</span><br><span class="line">            element.Measure(availableSize);</span><br><span class="line">            Size desiredSize = element.DesiredSize; <span class="comment">// 所需尺寸</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (GetLineBreakBefore(element) ||</span><br><span class="line">                currentLineSize.Width + desiredSize.Width &gt; availableSize.Width)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 切换到新行（要么是因为元素请求了它，要么是因为空间用完了）。</span></span><br><span class="line">                panelSize.Width = Math.Max(currentLineSize.Width, panelSize.Width);</span><br><span class="line">                panelSize.Height += currentLineSize.Height;</span><br><span class="line">                currentLineSize = desiredSize;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果元素太宽，无法使用线的最大宽度进行匹配，只需给它一条单独的线。</span></span><br><span class="line">                <span class="keyword">if</span> (desiredSize.Width &gt; availableSize.Width)</span><br><span class="line">                &#123;</span><br><span class="line">                    panelSize.Width = Math.Max(desiredSize.Width, panelSize.Width);</span><br><span class="line">                    panelSize.Height += desiredSize.Height;</span><br><span class="line">                    currentLineSize = <span class="keyword">new</span> Size();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 继续添加到当前行。</span></span><br><span class="line">                currentLineSize.Width += desiredSize.Width;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 确保线条与其最高的元素一样高。</span></span><br><span class="line">                currentLineSize.Height = Math.Max(desiredSize.Height, currentLineSize.Height);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回适合所有元素所需的尺寸。</span></span><br><span class="line">        <span class="comment">// 通常，这是约束的宽度，高度基于元素的大小。但是，如果元素比面板的宽度宽，则所需的宽度将是该线的宽度</span></span><br><span class="line">        panelSize.Width = Math.Max(currentLineSize.Width, panelSize.Width);</span><br><span class="line">        panelSize.Height += currentLineSize.Height;</span><br><span class="line">        <span class="keyword">return</span> panelSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Size <span class="title">ArrangeOverride</span>(<span class="params">Size finalSize</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        Size currentLineSize = <span class="keyword">new</span> Size(); <span class="comment">// 当前行的尺寸</span></span><br><span class="line">        <span class="built_in">double</span> accumulatedHeight = <span class="number">0</span>; <span class="comment">// 累积的高度</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (UIElement element <span class="keyword">in</span> <span class="keyword">base</span>.InternalChildren)</span><br><span class="line">        &#123;</span><br><span class="line">            Size desiredSize = element.DesiredSize; <span class="comment">// 获取元素所需的尺寸</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (GetLineBreakBefore(element) ||</span><br><span class="line">                currentLineSize.Width + desiredSize.Width &gt; finalSize.Width)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 切换到新行（要么是因为元素请求了它，要么是因为空间用完了）</span></span><br><span class="line">                accumulatedHeight += currentLineSize.Height; <span class="comment">// 累加当前行的高度</span></span><br><span class="line">                currentLineSize = <span class="keyword">new</span> Size(desiredSize.Width, desiredSize.Height); <span class="comment">// 重置当前行尺寸为新元素的尺寸</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果元素太宽，无法使用行的最大宽度进行匹配，只需给它一条单独的行</span></span><br><span class="line">                <span class="keyword">if</span> (desiredSize.Width &gt; finalSize.Width)</span><br><span class="line">                &#123;</span><br><span class="line">                    element.Arrange(<span class="keyword">new</span> Rect(<span class="keyword">new</span> Point(<span class="number">0</span>, accumulatedHeight), desiredSize)); <span class="comment">// 布置元素</span></span><br><span class="line">                    accumulatedHeight += desiredSize.Height; <span class="comment">// 累加元素的高度</span></span><br><span class="line">                    currentLineSize = <span class="keyword">new</span> Size(); <span class="comment">// 重置当前行尺寸</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    element.Arrange(<span class="keyword">new</span> Rect(<span class="keyword">new</span> Point(<span class="number">0</span>, accumulatedHeight), desiredSize)); <span class="comment">// 布置元素</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 继续添加到当前行</span></span><br><span class="line">                element.Arrange(<span class="keyword">new</span> Rect(<span class="keyword">new</span> Point(currentLineSize.Width, accumulatedHeight), desiredSize)); <span class="comment">// 布置元素</span></span><br><span class="line">                currentLineSize.Width += desiredSize.Width; <span class="comment">// 增加当前行的宽度</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 确保行的高度与其最高的元素一样高</span></span><br><span class="line">                currentLineSize.Height = Math.Max(desiredSize.Height, currentLineSize.Height); <span class="comment">// 设置当前行的高度为最大元素高度</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回面板的最终大小</span></span><br><span class="line">        accumulatedHeight += currentLineSize.Height; <span class="comment">// 累加最后一行的高度</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Size(finalSize.Width, accumulatedHeight); <span class="comment">// 返回面板尺寸</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="wrapbreakpanel-2"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Window</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Class</span>=<span class="string">&quot;WpfApp.MainWindow&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:d</span>=<span class="string">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:lib</span>=<span class="string">&quot;clr-namespace:CustomControlLibrary;assembly=CustomControlLibrary&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:local</span>=<span class="string">&quot;clr-namespace:WpfApp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:r</span>=<span class="string">&quot;clr-namespace:ResourceLibrary;assembly=ResourceLibrary&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Title</span>=<span class="string">&quot;MainWindow&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Width</span>=<span class="string">&quot;375&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Height</span>=<span class="string">&quot;260&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">StackPanel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">StackPanel.Resources</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Style</span> <span class="attr">TargetType</span>=<span class="string">&quot;&#123;x:Type Button&#125;&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Setter</span> <span class="attr">Property</span>=<span class="string">&quot;Margin&quot;</span> <span class="attr">Value</span>=<span class="string">&quot;3&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Setter</span> <span class="attr">Property</span>=<span class="string">&quot;Padding&quot;</span> <span class="attr">Value</span>=<span class="string">&quot;3&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">            </span><span class="tag">&lt;/<span class="name">Style</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">StackPanel.Resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextBlock</span> <span class="attr">Padding</span>=<span class="string">&quot;5&quot;</span> <span class="attr">Background</span>=<span class="string">&quot;LightGray&quot;</span>&gt;</span></span><br><span class="line">            Content above the WQrapBreakPanel</span><br><span class="line">        <span class="tag">&lt;/<span class="name">TextBlock</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lib:WrapBreakPanel</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span>&gt;</span>No Break Here<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span>&gt;</span>No Break Here<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span>&gt;</span>No Break Here<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span>&gt;</span>No Break Here<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span> <span class="attr">lib:WrapBreakPanel.LineBreakBefore</span>=<span class="string">&quot;True&quot;</span> <span class="attr">FontWeight</span>=<span class="string">&quot;Bold&quot;</span>&gt;</span>Button with Break<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span>&gt;</span>No Break Here<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span>&gt;</span>No Break Here<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span>&gt;</span>No Break Here<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Button</span>&gt;</span>No Break Here<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lib:WrapBreakPanel</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextBlock</span> <span class="attr">Padding</span>=<span class="string">&quot;5&quot;</span> <span class="attr">Background</span>=<span class="string">&quot;LightGray&quot;</span>&gt;</span></span><br><span class="line">            Content below the WrapBreakPanel</span><br><span class="line">        <span class="tag">&lt;/<span class="name">TextBlock</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">StackPanel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Window</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<p>&emsp;&emsp;唯一保留的细节是当执行布局逻辑时需要考虑该属性。WrapBreakPanel面板的布局逻辑以WrapPanel 面板的布局逻辑为基础。在测量阶段，元素按行排列，从而使面板能够计算需要的总空间。除非太大或LineBreakBefore属性被设置为tue，否则每个元素都被添加到当前行中。</p>
<h2 id="自定义绘图元素"><a href="#自定义绘图元素" class="headerlink" title="自定义绘图元素"></a>自定义绘图元素</h2><p>&emsp;&emsp;前面已经开始分析 WPF元素的内部工作原理--允许每个元素插入到WPF布局系统的MeasureOverride()和 ArrangeOverride()方法中。本节将进一步深入分析和研究元素如何渲染它们自身。</p>
<p>&emsp;&emsp;<em>大多数 WPF 元素通过组合方式创建可视化外观。换句话说，典型的元素通过其他更基础的元素进行构建。在本章的整个内容中您已经看到了这种工作模式。例如，使用标记定义用户控件的组合元素，处理标记的方式与自定义窗口中的XAML 相同。使用控件模板为自定义控件定义可视化树。并且当创建自定义面板时，根本不必定义任何可视化细节。组合元素由控件使用者提供，并添加到 Children 集合中。</em></p>
<h3 id="OnRender-方法"><a href="#OnRender-方法" class="headerlink" title="OnRender()方法"></a>OnRender()方法</h3><p>&emsp;&emsp;为了执行自定义渲染，元素必须重写0nRender()方法，该方法继承自UIElement 基类OnRender()方法未必不需要替换组合——<strong>一些控件使用OnRender()方法绘制可视化细节并使用组合在其上叠加其他元素。</strong>Border和Panel类是两个例子，Border 类在 OnRender()方法中绘制边框，Panel类在 OnRender()方法中绘制背景。Border和 Panel类都支持子内容，并且这些子内容在自定义的绘图细节之上进行渲染。</p>
<p>&emsp;&emsp;<em>OnRender()方法接收一个 DrawingContext 对象，该对象为绘制内容提供了一套很有用的方法。第一次学习 DrawingContext 类的相关内容是在第14章，在该章中使用该类为 Visual 对象绘制内容。在 OnRender()方法中执行绘图的主要区别是不能显式地创建和关闭 DrawingContext对象。这是因为几个不同的 OnRender()方法可能使用相同的 DrawingContext对象。例如，派生的元素可以执行一些自定义绘图操作并调用基类中的 OnRender()方法来绘制其他内容。这种方法是可行的，因为当开始这一过程时，WPF会自动创建 DrawingContext 对象，并且当不再需要时关闭该对象。</em></p>
<div class="note info flat"><p>&emsp;&emsp;从技术角度看，OnRender()方法实际上没有将内容绘制到屏幕上，而是绘制到 DrawingContext对象上，然后 WPF 缓存这些信息。WPF 决定元素何时需要重新绘制并绘制使用 DrawingContext对象创建的内容。这是 WPF 保留模式图形系统的本质-- 由您定义内容，WPF 无缝地管理绘制和刷新过程。</p>
</div>

<blockquote>
<p>关于 WPF 渲染，最令人惊奇的细节是实际上只需要使用很少的类。大多数类是通过其他更简单的类构建的，并且对于典型的控件，为了找到实际重写OnRender()方法的类，需要进入到控件元素树中非常深的层次。下面是一些重写了OnRender()方法的类:</p>
</blockquote>
<ul>
<li><strong>TextBlock</strong>类。无论在何处放置文本，都有<em>TextBlock</em>对象使用<code>OnRender()</code>方法绘制文本</li>
<li><strong>Image</strong>类。<em>Image</em>类重写<code>OnRender()</code>方法，使用*DrawingContext.DrawImage()*方法绘制图形内容</li>
<li><strong>MediaElement</strong>类。如果正在使用该类播放视频文件，该类会重写<code>OnRender()</code>方法以绘制视频帧</li>
<li><strong>各种形状</strong>类。<em>Shape</em>基类重写了<code>OnRender()</code>方法，通过使用<em>DrawingContext.DrawGeometry()<em>方法，绘制在其内部存储的</em>Geometry</em>对象。根据<em>Shape</em>类的特定派生类，<em>Geometry</em>对象可以表示椭圆、矩形或更复杂的由直线和曲线构成的路径。许多元素使用形状绘制小的可视化细节</li>
<li><strong>各种修饰</strong>类。这些类（如<em>ButtonChrome</em>和<em>ListBoxChrome</em>）绘制通用控件的外侧外观，并在具体指定的内部放置内容。其他许多继承自<code>Decorator</code>的类，如<em>Border</em>类，都重写了<code>OnRender()</code>方法</li>
<li><strong>各种面板</strong>类。尽管面板的内容是由其子元素提供的，但是<code>OnRender()</code>方法绘制具有背景色（假设设置了<em>background</em>属性）的矩形</li>
</ul>
<blockquote>
<p>通常，<code>OnRender()</code>方法的实现看起来很简单。例如，下面是继承自<code>Shape</code>类的所有渲染代码：</p>
</blockquote>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnRender</span>(<span class="params">DrawingContext dc</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">this</span>.EnsureRenderedGeometry();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._renderedGeometry != Geometry.Empty)</span><br><span class="line">    &#123;</span><br><span class="line">        dc.DrawGeometry(<span class="keyword">this</span>.Fill, <span class="keyword">this</span>.GetPen(), <span class="keyword">this</span>._renderedGeometry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;请记住，重写 OnRender()方法不是渲染内容并且将其添加到用户界面的唯一方法。也可以创建 DrawingVisual 对象，并使用 AddVisualChild()方法为 UElement对象添加该可视化对象(并实现其他一些细节，正如在第 14 章中描述的那样)。然后可以调用 DrawingVisual,RenderOpen()方法为 DrawimgVisual 对象检索 DrawingContext对象，并使用返回的 DrawingContext 对象渲染DrawingVisual对象的内容。</p>
<p>&emsp;&emsp;<strong>在 WPF 中，一些元素使用这种策略在其他元素内容之上显示一些图形细节。</strong>例如，在拖放指示器、错误指示器以及焦点框中可以看到这种情况。在所有这些情况中，DrawingVisua类允许元素在其他内容之上绘制内容，而不是在其他内容之下绘制内容。但对于大部分情况，是在专门的 OnRender()方法中进行渲染。</p>
<h3 id="评估自定义绘图"><a href="#评估自定义绘图" class="headerlink" title="评估自定义绘图"></a>评估自定义绘图</h3><p>&emsp;&emsp;<strong>当创建自定义元素时，可能会选择重写 OnRender()方法来绘制自定义内容。可在包含内容的元素(最常见的情况是继承自 Decorator的类)中重写 OnRender()方法,从而可以在内容周围添加图形装饰。也可以在没有任何嵌套内容的元素中重写OnRender()方法，从而可以绘制元素的整个可视化外观。</strong>例如，可以创建绘制一些小的图形细节的自定义元素，然后可以通过组合，在其他类中使用自定义元素。WPF中的这方面示例是 TickBar 元素，该元素为 Slider 控件绘制刻度标记。TickBar 元素通过 Slider 控件的默认控件模板(该模板还包括一个 Border 和一个 Track元素，Track 元素又包含了两个 RepeatButton 控件和一个 Thumb 元素)嵌入到 Slider 控件的可视化树中。</p>
<p>&emsp;&emsp;一个明显的问题是需要确定何时使用较低级的 OnRender()方法，以及何时使用其他类(例如，继承自 Shape 类的元素)的组合来绘制所需的内容。为了做出决定，需要评估所需图形的复杂程度以及希望提供的交互能力。</p>
<p>&emsp;&emsp;<em>例如，分析一下 ButtonChrome 类。在 ButtonChrome 类的 WPF 实现中，自定义的渲染代码考虑了各种属性，包括RenderDefaulted、RenderMouseOver 以及 RenderPressed。Button 类的默认控件模板在适当的时机使用触发器设置这些属性，就像在第17章中看到的那样。例如，当将鼠标移动到按钮上时，Button类使用触发器将 ButtonChrome.RenderMouseOver属性设置为tnue。</em></p>
<p>&emsp;&emsp;<em>无论何时改变 RenderDefaulted、RenderMouseOver或RenderPressed 属性，ButtonChrome类都会调用基本的InvalidateVisual()方法来指示当前外观不再有效。WPF然后调用ButtonChrome.OnRender()方法来获取新的图形表示。</em></p>
<p>&emsp;&emsp;如果 ButtonChrome 类使用组合，这种行为就更难实现。使用合适的元素为 ButtonChrome类创建标准外观很容易，但是当按钮的状态发生变化时，需要做更多的工作来修改外观。需要动态改变构成 ButtonChrome类的嵌套元素，如果外观变化很大的话，就必须隐藏一个元素并在合适的位置显示另一个元素。<br>&emsp;&emsp;大多数自定义元素不需要自定义渲染。但是<strong>当属性发生变化或执行特定操作时，需要渲染复杂的变化很大的可视化外观，此时使用自定义的渲染方法可能更加简单并且更便捷。</strong></p>
<h3 id="自定义绘图元素-1"><a href="#自定义绘图元素-1" class="headerlink" title="自定义绘图元素"></a>自定义绘图元素</h3><p>&emsp;&emsp;下面的代码定义了名为 CustomDrawElement 的元素，演示了一种简单的效果。该元素使用RadialGradientBrush 画刷绘制阴影背景。技巧是动态设置强调显示的渐变起点，使其跟随鼠标。从而当用户在控件上移动鼠标时，白色的发光中心点跟随鼠标移动。</p>
<p>&emsp;&emsp;CustomDrawnElement 元索不需要包含任何子内容，所以它直接继承自FrameworkElement类。该元素只提供了一个可以设置的属性——渐变的背景色(前景色被硬编码为白色，尽管可以很容易地改变这一细节)。</p>
<img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/h55EYn7aBK.gif"/>

<div class="tabs" id="customdrawelement"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="customdrawelement-1">CustomDrawElement</button><button type="button" class="tab " data-href="customdrawelement-2">Use CustomDrawElement</button></ul><div class="tab-contents"><div class="tab-item-content active" id="customdrawelement-1"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomDrawElement</span> : <span class="title">FrameworkElement</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> System.Windows.Media.Color BackgroundColor</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> (Color)GetValue(BackgroundColorProperty); &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; SetValue(BackgroundColorProperty, <span class="keyword">value</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty BackgroundColorProperty =</span><br><span class="line">        DependencyProperty.Register(</span><br><span class="line">            <span class="string">&quot;BackgroundColor&quot;</span>,</span><br><span class="line">            <span class="keyword">typeof</span>(Color),</span><br><span class="line">            <span class="keyword">typeof</span>(CustomDrawElement),</span><br><span class="line">            <span class="keyword">new</span> FrameworkPropertyMetadata(Colors.Yellow)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 标识WPF将自动调用OnRender()方法，通过调用InvalidateVisual()</span></span><br><span class="line">                AffectsRender = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnMouseMove</span>(<span class="params">MouseEventArgs e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnMouseMove(e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.InvalidateVisual();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnMouseLeave</span>(<span class="params">MouseEventArgs e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnMouseLeave(e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.InvalidateVisual();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnRender</span>(<span class="params">DrawingContext drawingContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnRender(drawingContext);</span><br><span class="line"></span><br><span class="line">        Rect bounds = <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">base</span>.ActualWidth, <span class="keyword">base</span>.ActualHeight);</span><br><span class="line">        drawingContext.DrawRectangle(GetForegroundBrush(), <span class="literal">null</span>, bounds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Brush <span class="title">GetForegroundBrush</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!IsMouseOver)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SolidColorBrush(BackgroundColor);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            RadialGradientBrush brush = <span class="keyword">new</span> RadialGradientBrush(Colors.White, BackgroundColor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get the position of the mouse in device-independent units, relative to the control itself.</span></span><br><span class="line">            Point absoluteGradientOrigin = Mouse.GetPosition(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Convert the point coordinates to proportional (0 to 1) values.</span></span><br><span class="line">            Point relativeGradientOrigin = <span class="keyword">new</span> Point(</span><br><span class="line">                absoluteGradientOrigin.X / <span class="keyword">base</span>.ActualWidth,</span><br><span class="line">                absoluteGradientOrigin.Y / <span class="keyword">base</span>.ActualHeight);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Adjust the brush</span></span><br><span class="line">            brush.GradientOrigin = relativeGradientOrigin;</span><br><span class="line">            brush.Center = relativeGradientOrigin;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> brush;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="customdrawelement-2"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Window</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Class</span>=<span class="string">&quot;WpfApp.MainWindow&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:d</span>=<span class="string">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:lib</span>=<span class="string">&quot;clr-namespace:CustomControlLibrary;assembly=CustomControlLibrary&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:local</span>=<span class="string">&quot;clr-namespace:WpfApp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:r</span>=<span class="string">&quot;clr-namespace:ResourceLibrary;assembly=ResourceLibrary&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Title</span>=<span class="string">&quot;MainWindow&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Width</span>=<span class="string">&quot;375&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Height</span>=<span class="string">&quot;260&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lib:CustomDrawElement</span> <span class="attr">BackgroundColor</span>=<span class="string">&quot;LightGreen&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Window</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<p>&emsp;&emsp;<strong>BackgroundColor依赖项属性使用FrameworkPropertyMetadata.AffectRender标志明确进行了标识。因此，无论何时改变了背景色，WPF都自动调用 OnRender()方法。然而，当鼠标移动到新的位置时，也需要确保调用 OnRender()方法。这是通过在合适的时间调用InvalidateVisual()方法实现的。</strong></p>
<h3 id="创建自定义装饰元素"><a href="#创建自定义装饰元素" class="headerlink" title="创建自定义装饰元素"></a>创建自定义装饰元素</h3><p>&emsp;&emsp;作为一条通用规则，切勿在控件中使用自定义绘图。如果在控件中使用自定义绘图，就违反了 WPF无外观控件的承诺。问题是一旦硬编码一些绘图逻辑，就会使控件可视化外观的一部分不能通过控件模板进行定制。</p>
<p>&emsp;&emsp;更好的方法是设计单独的绘制自定义内容的元素(例如上一个示例中的 CustomDrawnElement类)，然后在控件的默认模板内部使用自定义元素。很多WPF 控件使用这种方法，您在第17章中看到的 Button 控件，使用的就是这种方法。</p>
<blockquote>
<p>在控件模板中，自定义绘图元素通常扮演两个角色</p>
</blockquote>
<ul>
<li>它们绘制一些小的图形细节（例如滚动按钮上的箭头）</li>
<li>它们在另一个元素的周围提供更加详细的背景或边框</li>
</ul>
<p>&emsp;&emsp;第二种方法需要自定义装饰元素。可以通过两个轻微的改动将CustomDrawElement 类转换成自定义绘图元素。首先，使该类继承自Decorator类:</p>
<img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/h2VxomNCGN.gif"/>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomDrawDecorator</span> : <span class="title">Decorator</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;然后重写<code>OnMeasure()</code>方法，指定需要的尺寸。所有装饰元素都会考虑它们的子元素，增加装饰所需要的额外控件，然后返回组合之后的尺寸。<code>CustomDrawDecorator</code>类不需要任何额外的空间来绘制边框，相反，使用下面的代码简单地使自身和其内容具有相同的尺寸：</p>
<div class="tabs" id="customdrawdecorator"><ul class="nav-tabs"><button type="button" class="tab  active" data-href="customdrawdecorator-1">CustomDrawDecorator</button><button type="button" class="tab " data-href="customdrawdecorator-2">Use CustomDrawDecorator</button></ul><div class="tab-contents"><div class="tab-item-content active" id="customdrawdecorator-1"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomDrawDecorator</span> : <span class="title">Decorator</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Size <span class="title">MeasureOverride</span>(<span class="params">Size constraint</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        UIElement child = <span class="keyword">this</span>.Child;</span><br><span class="line">        <span class="keyword">if</span> (child != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            child.Measure(constraint);</span><br><span class="line">            <span class="keyword">return</span> child.DesiredSize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Size();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> System.Windows.Media.Color BackgroundColor</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> (Color)GetValue(BackgroundColorProperty); &#125;</span><br><span class="line">        <span class="keyword">set</span> &#123; SetValue(BackgroundColorProperty, <span class="keyword">value</span>); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> DependencyProperty BackgroundColorProperty =</span><br><span class="line">        DependencyProperty.Register(</span><br><span class="line">            <span class="string">&quot;BackgroundColor&quot;</span>,</span><br><span class="line">            <span class="keyword">typeof</span>(Color),</span><br><span class="line">            <span class="keyword">typeof</span>(CustomDrawDecorator),</span><br><span class="line">            <span class="keyword">new</span> FrameworkPropertyMetadata(Colors.Yellow)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 标识WPF将自动调用OnRender()方法，通过调用InvalidateVisual()</span></span><br><span class="line">                AffectsRender = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnMouseMove</span>(<span class="params">MouseEventArgs e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnMouseMove(e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.InvalidateVisual();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnMouseLeave</span>(<span class="params">MouseEventArgs e</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnMouseLeave(e);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.InvalidateVisual();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnRender</span>(<span class="params">DrawingContext drawingContext</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">base</span>.OnRender(drawingContext);</span><br><span class="line"></span><br><span class="line">        Rect bounds = <span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, <span class="keyword">base</span>.ActualWidth, <span class="keyword">base</span>.ActualHeight);</span><br><span class="line">        drawingContext.DrawRectangle(GetForegroundBrush(), <span class="literal">null</span>, bounds);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Brush <span class="title">GetForegroundBrush</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!IsMouseOver)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SolidColorBrush(BackgroundColor);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            RadialGradientBrush brush = <span class="keyword">new</span> RadialGradientBrush(Colors.White, BackgroundColor);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Get the position of the mouse in device-independent units, relative to the control itself.</span></span><br><span class="line">            Point absoluteGradientOrigin = Mouse.GetPosition(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Convert the point coordinates to proportional (0 to 1) values.</span></span><br><span class="line">            Point relativeGradientOrigin = <span class="keyword">new</span> Point(</span><br><span class="line">                absoluteGradientOrigin.X / <span class="keyword">base</span>.ActualWidth,</span><br><span class="line">                absoluteGradientOrigin.Y / <span class="keyword">base</span>.ActualHeight);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Adjust the brush</span></span><br><span class="line">            brush.GradientOrigin = relativeGradientOrigin;</span><br><span class="line">            brush.Center = relativeGradientOrigin;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> brush;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-item-content" id="customdrawdecorator-2"><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Window</span></span></span><br><span class="line"><span class="tag">    <span class="attr">x:Class</span>=<span class="string">&quot;WpfApp.MainWindow&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:x</span>=<span class="string">&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:d</span>=<span class="string">&quot;http://schemas.microsoft.com/expression/blend/2008&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:lib</span>=<span class="string">&quot;clr-namespace:CustomControlLibrary;assembly=CustomControlLibrary&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:local</span>=<span class="string">&quot;clr-namespace:WpfApp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:r</span>=<span class="string">&quot;clr-namespace:ResourceLibrary;assembly=ResourceLibrary&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Title</span>=<span class="string">&quot;MainWindow&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Width</span>=<span class="string">&quot;375&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">Height</span>=<span class="string">&quot;260&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Window.Resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ControlTemplate</span> <span class="attr">x:Key</span>=<span class="string">&quot;ButtonWithCustomChrome&quot;</span> <span class="attr">TargetType</span>=<span class="string">&quot;&#123;x:Type Button&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lib:CustomDrawDecorator</span> <span class="attr">BackgroundColor</span>=<span class="string">&quot;LightGreen&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ContentPresenter</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">Margin</span>=<span class="string">&quot;&#123;TemplateBinding Padding&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">HorizontalAlignment</span>=<span class="string">&quot;&#123;TemplateBinding HorizontalContentAlignment&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">VerticalAlignment</span>=<span class="string">&quot;&#123;TemplateBinding VerticalContentAlignment&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">Content</span>=<span class="string">&quot;&#123;TemplateBinding ContentControl.Content&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">ContentTemplate</span>=<span class="string">&quot;&#123;TemplateBinding ContentControl.ContentTemplate&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">RecognizesAccessKey</span>=<span class="string">&quot;True&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lib:CustomDrawDecorator</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ControlTemplate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Window.Resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Grid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Width</span>=<span class="string">&quot;100&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Height</span>=<span class="string">&quot;40&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">Template</span>=<span class="string">&quot;&#123;StaticResource ButtonWithCustomChrome&#125;&quot;</span>&gt;</span></span><br><span class="line">            Button</span><br><span class="line">        <span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Grid</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Window</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div><div class="tab-to-top"><button type="button" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div>

<p>&emsp;&emsp;现在可以使用这个模板重新样式化按钮，使其具有新的外观。当然，为了使自定义装饰元索更加实用，当单击鼠标按钮时可能希望改变它的外观。使用修改装饰类属性的触发器可以完成该工作。之前在第17章中已经全面讨论了这一设计。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://bootree.cn">大白</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://bootree.cn/2024/07/27/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/18%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%83%E7%B4%A0/">http://bootree.cn/2024/07/27/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/18%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%83%E7%B4%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://bootree.cn" target="_blank">生活中的tree</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/">WPF从入门到入坟</a></div><div class="post_share"><div class="social-share" data-image="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://jsd.012700.xyz/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://jsd.012700.xyz/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "/img/loading.gif" data-lazy-src="/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2024/07/22/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/17%E6%8E%A7%E4%BB%B6%E6%A8%A1%E6%9D%BF/" title="WPF从入门到入坟 - 17控件模板"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">WPF从入门到入坟 - 17控件模板</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/05/22/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/01%E6%A6%82%E8%BF%B0/" title="WPF从入门到入坟 - 01概述"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-22</div><div class="title">WPF从入门到入坟 - 01概述</div></div></a></div><div><a href="/2024/05/25/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/04%E4%BE%9D%E8%B5%96%E5%B1%9E%E6%80%A7/" title="WPF从入门到入坟 - 04依赖属性"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-25</div><div class="title">WPF从入门到入坟 - 04依赖属性</div></div></a></div><div><a href="/2024/05/23/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/02XAML/" title="WPF从入门到入坟 - 02XAML"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240527195528.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-23</div><div class="title">WPF从入门到入坟 - 02XAML</div></div></a></div><div><a href="/2024/05/24/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/03%E5%B8%83%E5%B1%80/" title="WPF从入门到入坟 - 03布局"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/20240527195817.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-24</div><div class="title">WPF从入门到入坟 - 03布局</div></div></a></div><div><a href="/2024/05/28/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/05%E8%B7%AF%E7%94%B1%E4%BA%8B%E4%BB%B6/" title="WPF从入门到入坟 - 05路由事件"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-28</div><div class="title">WPF从入门到入坟 - 05路由事件</div></div></a></div><div><a href="/2024/05/29/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/06%E6%8E%A7%E4%BB%B6/" title="WPF从入门到入坟 - 06控件"><img class="cover" src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-29</div><div class="title">WPF从入门到入坟 - 06控件</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "/img/loading.gif" data-lazy-src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">大白</div><div class="author-info__description">人不可能同时拥有青春和对青春的感受</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">9</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/cnlicm"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/cnlicm" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github" style="color: #hdhfbb;"></i></a><a class="social-icon" href="mailto:codenobugs@foxmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #000000;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">A lazy guy. My dream is that generate electricity with love.</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%90%86%E8%A7%A3WPF%E4%B8%AD%E7%9A%84%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%83%E7%B4%A0"><span class="toc-number">1.</span> <span class="toc-text">理解WPF中的自定义元素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E5%9F%BA%E6%9C%AC%E7%9A%84%E7%94%A8%E6%88%B7%E6%8E%A7%E4%BB%B6"><span class="toc-number">2.</span> <span class="toc-text">构建基本的用户控件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E4%BE%9D%E8%B5%96%E9%A1%B9%E5%B1%9E%E6%80%A7"><span class="toc-number">2.1.</span> <span class="toc-text">定义依赖项属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1%E4%BA%8B%E4%BB%B6"><span class="toc-number">2.2.</span> <span class="toc-text">定义路由事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%A0%87%E8%AE%B0"><span class="toc-number">2.3.</span> <span class="toc-text">添加标记</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%8E%A7%E4%BB%B6"><span class="toc-number">2.4.</span> <span class="toc-text">使用控件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%94%AF%E6%8C%81"><span class="toc-number">2.5.</span> <span class="toc-text">命令支持</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E5%8F%AF%E9%9D%A0%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">2.5.1.</span> <span class="toc-text">更可靠的命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90%E7%94%A8%E6%88%B7%E6%8E%A7%E4%BB%B6"><span class="toc-number">2.6.</span> <span class="toc-text">深入分析用户控件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%97%A0%E5%A4%96%E8%A7%82%E6%8E%A7%E4%BB%B6"><span class="toc-number">3.</span> <span class="toc-text">创建无外观控件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%A2%9C%E8%89%B2%E6%8B%BE%E5%8F%96%E5%99%A8%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">3.1.</span> <span class="toc-text">修改颜色拾取器的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%A2%9C%E8%89%B2%E6%8B%BE%E5%8F%96%E5%99%A8%E7%9A%84%E6%A0%87%E8%AE%B0"><span class="toc-number">3.2.</span> <span class="toc-text">修改颜色拾取器的标记</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B2%BE%E7%AE%80%E6%8E%A7%E4%BB%B6%E6%A8%A1%E6%9D%BF"><span class="toc-number">3.3.</span> <span class="toc-text">精简控件模板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E9%83%A8%E4%BB%B6%E5%90%8D%E7%A7%B0"><span class="toc-number">3.3.1.</span> <span class="toc-text">添加部件名称</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E6%A8%A1%E6%9D%BF%E9%83%A8%E4%BB%B6"><span class="toc-number">3.3.2.</span> <span class="toc-text">操作模板部件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%B0%E5%BD%95%E6%A8%A1%E6%9D%BF%E9%83%A8%E4%BB%B6"><span class="toc-number">3.3.3.</span> <span class="toc-text">记录模板部件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E5%8F%AF%E8%A7%86%E5%8C%96%E7%8A%B6%E6%80%81"><span class="toc-number">4.</span> <span class="toc-text">支持可视化状态</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E7%BC%96%E5%86%99FlipPanel%E7%B1%BB"><span class="toc-number">4.1.</span> <span class="toc-text">开始编写FlipPanel类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E9%83%A8%E4%BB%B6%E5%92%8C%E7%8A%B6%E6%80%81"><span class="toc-number">4.2.</span> <span class="toc-text">选择部件和状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E6%8E%A7%E4%BB%B6%E6%A8%A1%E6%9D%BF"><span class="toc-number">4.3.</span> <span class="toc-text">默认控件模板</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BF%BB%E8%BD%AC%E5%8A%A8%E7%94%BB"><span class="toc-number">4.3.1.</span> <span class="toc-text">翻转动画</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E7%8A%B6%E6%80%81%E5%8A%A8%E7%94%BB"><span class="toc-number">4.3.2.</span> <span class="toc-text">定义状态动画</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E7%8A%B6%E6%80%81%E8%BF%87%E6%B8%A1"><span class="toc-number">4.3.3.</span> <span class="toc-text">定义状态过渡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E8%81%94%E5%85%83%E7%B4%A0"><span class="toc-number">4.3.4.</span> <span class="toc-text">关联元素</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8FlipPanel%E6%8E%A7%E4%BB%B6"><span class="toc-number">4.4.</span> <span class="toc-text">使用FlipPanel控件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%8D%E5%90%8C%E7%9A%84%E6%8E%A7%E4%BB%B6%E6%A8%A1%E6%9D%BF"><span class="toc-number">4.5.</span> <span class="toc-text">使用不同的控件模板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E9%9D%A2%E6%9D%BF"><span class="toc-number">5.</span> <span class="toc-text">创建自定义面板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%A4%E6%AD%A5%E5%B8%83%E5%B1%80%E8%BF%87%E7%A8%8B"><span class="toc-number">6.</span> <span class="toc-text">两步布局过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MeasureOverride-%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.</span> <span class="toc-text">MeasureOverride()方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ArrangeOverride-%E6%96%B9%E6%B3%95"><span class="toc-number">6.2.</span> <span class="toc-text">ArrangeOverride()方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Canvas%E9%9D%A2%E6%9D%BF%E7%9A%84%E5%89%AF%E6%9C%AC"><span class="toc-number">6.3.</span> <span class="toc-text">Canvas面板的副本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E5%A5%BD%E7%9A%84WrapPanel%E9%9D%A2%E6%9D%BF"><span class="toc-number">6.4.</span> <span class="toc-text">更好的WrapPanel面板</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%98%E5%9B%BE%E5%85%83%E7%B4%A0"><span class="toc-number">7.</span> <span class="toc-text">自定义绘图元素</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OnRender-%E6%96%B9%E6%B3%95"><span class="toc-number">7.1.</span> <span class="toc-text">OnRender()方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%84%E4%BC%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%98%E5%9B%BE"><span class="toc-number">7.2.</span> <span class="toc-text">评估自定义绘图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%98%E5%9B%BE%E5%85%83%E7%B4%A0-1"><span class="toc-number">7.3.</span> <span class="toc-text">自定义绘图元素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A3%85%E9%A5%B0%E5%85%83%E7%B4%A0"><span class="toc-number">7.4.</span> <span class="toc-text">创建自定义装饰元素</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/07/27/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/18%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%83%E7%B4%A0/" title="WPF从入门到入坟 - 18自定义元素"><img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WPF从入门到入坟 - 18自定义元素"/></a><div class="content"><a class="title" href="/2024/07/27/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/18%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%83%E7%B4%A0/" title="WPF从入门到入坟 - 18自定义元素">WPF从入门到入坟 - 18自定义元素</a><time datetime="2024-07-27T07:38:23.000Z" title="发表于 2024-07-27 15:38:23">2024-07-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/22/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/17%E6%8E%A7%E4%BB%B6%E6%A8%A1%E6%9D%BF/" title="WPF从入门到入坟 - 17控件模板"><img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WPF从入门到入坟 - 17控件模板"/></a><div class="content"><a class="title" href="/2024/07/22/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/17%E6%8E%A7%E4%BB%B6%E6%A8%A1%E6%9D%BF/" title="WPF从入门到入坟 - 17控件模板">WPF从入门到入坟 - 17控件模板</a><time datetime="2024-07-22T12:49:31.000Z" title="发表于 2024-07-22 20:49:31">2024-07-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/16/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/16%E9%AB%98%E7%BA%A7%E5%8A%A8%E7%94%BB/" title="WPF从入门到入坟 - 16高级动画"><img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WPF从入门到入坟 - 16高级动画"/></a><div class="content"><a class="title" href="/2024/07/16/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/16%E9%AB%98%E7%BA%A7%E5%8A%A8%E7%94%BB/" title="WPF从入门到入坟 - 16高级动画">WPF从入门到入坟 - 16高级动画</a><time datetime="2024-07-16T12:46:14.000Z" title="发表于 2024-07-16 20:46:14">2024-07-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/13/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/15%E5%8A%A8%E7%94%BB%E5%9F%BA%E7%A1%80/" title="WPF从入门到入坟 - 15动画基础"><img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WPF从入门到入坟 - 15动画基础"/></a><div class="content"><a class="title" href="/2024/07/13/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/15%E5%8A%A8%E7%94%BB%E5%9F%BA%E7%A1%80/" title="WPF从入门到入坟 - 15动画基础">WPF从入门到入坟 - 15动画基础</a><time datetime="2024-07-13T03:36:42.000Z" title="发表于 2024-07-13 11:36:42">2024-07-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/07/09/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/14%E6%95%88%E6%9E%9C%E5%92%8C%E5%8F%AF%E8%A7%86%E5%8C%96%E5%AF%B9%E8%B1%A1/" title="WPF从入门到入坟 - 14效果和可视化对象"><img src= "/img/loading.gif" data-lazy-src="https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="WPF从入门到入坟 - 14效果和可视化对象"/></a><div class="content"><a class="title" href="/2024/07/09/WPF%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9D%9F/14%E6%95%88%E6%9E%9C%E5%92%8C%E5%8F%AF%E8%A7%86%E5%8C%96%E5%AF%B9%E8%B1%A1/" title="WPF从入门到入坟 - 14效果和可视化对象">WPF从入门到入坟 - 14效果和可视化对象</a><time datetime="2024-07-09T13:35:03.000Z" title="发表于 2024-07-09 21:35:03">2024-07-09</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cnlicm-blog-image.oss-cn-shenzhen.aliyuncs.com/img/wpf.png')"><div id="footer-wrap"><div class="copyright">&copy;2024 By 大白</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener external nofollow noreferrer" href="https://beian.miit.gov.cn/"><img class="icp-icon" src= "/img/loading.gif" data-lazy-src="/img/2020011362.png"><span>赣ICP备2020011362号-2</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="translateLink" type="button" title="简繁转换">简</button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly@4.13.0/source/js/utils.min.js"></script><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly@4.13.0/source/js/main.min.js"></script><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly@4.13.0/source/js/tw_cn.min.js"></script><script src="https://jsd.012700.xyz/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://jsd.012700.xyz/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://jsd.012700.xyz/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><div class="js-pjax"><script>(() => {
  const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
  if ($mermaid.length === 0) return
  const runMermaid = () => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    Array.from($mermaid).forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = '%%{init:{ \'theme\':\'' + theme + '\'}}%%\n'
      const mermaidID = 'mermaid-' + index
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)

      const renderV10 = () => {
        renderFn.then(({svg}) => {
          mermaidSrc.insertAdjacentHTML('afterend', svg)
        })
      }

      const renderV9 = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      typeof renderFn === 'string' ? renderV9(renderFn) : renderV10()
    })
  }

  const loadMermaid = () => {
    window.loadMermaid ? runMermaid() : getScript('https://jsd.012700.xyz/npm/mermaid@10.8.0/dist/mermaid.min.js').then(runMermaid)
  }

  btf.addGlobalFn('themeChange', runMermaid, 'mermaid')

  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script data-pjax src="/self/btf.js"></script><script defer="defer" id="ribbon" src="https://jsd.012700.xyz/npm/butterfly-extsrc@1.1.3/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="true" data-click="true"></script><script src="https://jsd.012700.xyz/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/talking/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://jsd.012700.xyz/npm/hexo-theme-butterfly@4.13.0/source/js/search/local-search.min.js"></script></div></div></body></html>